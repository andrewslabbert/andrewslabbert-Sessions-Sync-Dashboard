<!DOCTYPE html>
<html lang="en" data-theme="dark"> <!-- Default theme is dark -->
<head>
    <meta charset="UTF-8">
    <!-- Viewport meta tag is added by Apps Script doGet -->
    <title>Sessions Sync Dashboard</title> <!-- Title set by Apps Script doGet -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Base CSS included to prevent flash of unstyled content -->
    <style>
        /* --- Configuration: Default Dark Mode --- */
        :root {
            --bg-primary-dark: #1a1d24; --bg-secondary-dark: #252932; --bg-tertiary-dark: #313641;
            --text-primary-dark: #e0e6f0; --text-secondary-dark: #a0a8b4; --text-tertiary-dark: #767f8d;
            --accent-primary-dark: #00f5d4; --accent-secondary-dark: #00bfa5; --color-success-dark: #34d399;
            --color-warning-dark: #f59e0b; --color-error-dark: #f43f5e; --border-color-dark: #3e4450;
            --border-highlight-dark: var(--accent-primary-dark); --placeholder-color-dark: #5a6372;
            --shadow-color-dark: rgba(0, 245, 212, 0.1); --button-primary-text-dark: var(--bg-primary-dark);
            --step-border-dark: var(--border-color-dark);
            --step-bg-dark: var(--bg-secondary-dark);
            --step-disabled-opacity-dark: 0.5;
            --step-connector-color-dark: var(--border-color-dark);
            --step-indicator-bg-dark: var(--bg-tertiary-dark);
            --step-indicator-text-dark: var(--text-secondary-dark);
            --step-indicator-complete-bg-dark: var(--color-success-dark);
            --step-indicator-error-bg-dark: var(--color-error-dark);
            --step-indicator-active-bg-dark: var(--color-warning-dark);
            --step-indicator-complete-text-dark: var(--bg-primary-dark);
        }
        /* --- Configuration: Light Mode --- */
        :root[data-theme="light"] {
            --bg-primary-light: #f8f9fa; --bg-secondary-light: #ffffff; --bg-tertiary-light: #e9ecef;
            --text-primary-light: #212529; --text-secondary-light: #495057; --text-tertiary-light: #6c757d;
            --accent-primary-light: #00a991; --accent-secondary-light: #007d6a; --color-success-light: #198754;
            --color-warning-light: #ffc107; --color-error-light: #dc3545; --border-color-light: #dee2e6;
            --border-highlight-light: var(--accent-primary-light); --placeholder-color-light: #adb5bd;
            --shadow-color-light: rgba(0, 169, 145, 0.2); --button-primary-text-light: #ffffff;
            --step-border-light: var(--border-color-light);
            --step-bg-light: var(--bg-secondary-light);
            --step-disabled-opacity-light: 0.6;
            --step-connector-color-light: var(--border-color-light);
            --step-indicator-bg-light: var(--bg-tertiary-light);
            --step-indicator-text-light: var(--text-secondary-light);
            --step-indicator-complete-bg-light: var(--color-success-light);
            --step-indicator-error-bg-light: var(--color-error-light);
            --step-indicator-active-bg-light: var(--color-warning-light);
            --step-indicator-complete-text-light: #ffffff;
        }
        /* --- Theme Variable Mapping --- */
        :root {
            --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --bg-tertiary: var(--bg-tertiary-dark);
            --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --text-tertiary: var(--text-tertiary-dark);
            --accent-primary: var(--accent-primary-dark); --accent-secondary: var(--accent-secondary-dark); --color-success: var(--color-success-dark);
            --color-warning: var(--color-warning-dark); --color-error: var(--color-error-dark); --border-color: var(--border-color-dark);
            --border-highlight: var(--border-highlight-dark); --placeholder-color: var(--placeholder-color-dark);
            --shadow-color: var(--shadow-color-dark); --button-primary-text: var(--button-primary-text-dark);
            --step-border: var(--step-border-dark); --step-bg: var(--step-bg-dark); --step-disabled-opacity: var(--step-disabled-opacity-dark);
            --step-connector-color: var(--step-connector-color-dark); --step-indicator-bg: var(--step-indicator-bg-dark);
            --step-indicator-text: var(--step-indicator-text-dark); --step-indicator-complete-bg: var(--step-indicator-complete-bg-dark);
            --step-indicator-error-bg: var(--step-indicator-error-bg-dark); --step-indicator-active-bg: var(--step-indicator-active-bg-dark);
            --step-indicator-complete-text: var(--step-indicator-complete-text-dark);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 8px; --transition-speed: 0.3s; --fast-transition-speed: 0.15s;
        }
        :root[data-theme="light"] {
            --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --bg-tertiary: var(--bg-tertiary-light);
            --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --text-tertiary: var(--text-tertiary-light);
            --accent-primary: var(--accent-primary-light); --accent-secondary: var(--accent-secondary-light); --color-success: var(--color-success-light);
            --color-warning: var(--color-warning-light); --color-error: var(--color-error-light); --border-color: var(--border-color-light);
            --border-highlight: var(--border-highlight-light); --placeholder-color: var(--placeholder-color-light);
            --shadow-color: var(--shadow-color-light); --button-primary-text: var(--button-primary-text-light);
             --step-border: var(--step-border-light); --step-bg: var(--step-bg-light); --step-disabled-opacity: var(--step-disabled-opacity-light);
            --step-connector-color: var(--step-connector-color-light); --step-indicator-bg: var(--step-indicator-bg-light);
            --step-indicator-text: var(--step-indicator-text-light); --step-indicator-complete-bg: var(--step-indicator-complete-bg-light);
            --step-indicator-error-bg: var(--step-indicator-error-bg-light); --step-indicator-active-bg: var(--step-indicator-active-bg-light);
            --step-indicator-complete-text: var(--step-indicator-complete-text-light);
        }
        /* --- Base & Reset --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; color-scheme: dark light; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }

        /* --- Layout --- */
        .dashboard-container {
            position: relative; /* Needed for absolute positioning of theme switch */
            width: 100%;
            max-width: 1200px; /* Maintain max width */
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        header { text-align: center; margin-bottom: 1rem; } /* Reduced bottom margin */
        header h1 { font-size: 2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
        header p { color: var(--text-secondary); font-size: 1rem; }

        /* --- Top Right Theme Switch --- */
        .top-right-theme-switch {
            position: absolute; top: 1rem; right: 1rem; z-index: 15;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .theme-switch { display: inline-block; height: 22px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--bg-tertiary); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: var(--transition-speed); border-radius: 22px; border: 1px solid var(--border-color); }
        .slider:before { background-color: var(--text-secondary); bottom: 2px; content: ""; height: 16px; left: 3px; position: absolute; transition: var(--transition-speed); width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-secondary); }
        input:checked + .slider:before { transform: translateX(22px); background-color: var(--bg-secondary); }
        .top-right-theme-switch .icon { stroke: var(--text-tertiary); width: 18px; height: 18px; }

        /* --- Stepper UI --- */
        .stepper-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Gap between steps and connectors */
            width: 100%;
            align-items: stretch; /* Make steps equal height */
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2rem;
        }
        .step {
            background-color: var(--step-bg);
            border: 1px solid var(--step-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex: 1 1 300px; /* Allow shrinking/growing, base width 300px */
            min-width: 280px; /* Prevent steps getting too narrow */
            transition: opacity var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .step-indicator {
            width: 32px; height: 32px; border-radius: 50%;
            background-color: var(--step-indicator-bg);
            color: var(--step-indicator-text);
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem;
            flex-shrink: 0;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .step-indicator .icon { width: 18px; height: 18px; } /* For icons inside indicator */
        .step-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .step-content { display: flex; flex-direction: column; gap: 0.75rem; flex-grow: 1; }
        .step-status { font-size: 0.9rem; color: var(--text-secondary); min-height: 1.6em; /* Prevent layout shifts */}
        .step-details { font-size: 0.85rem; color: var(--text-tertiary); margin-top: auto; padding-top: 0.5rem; } /* Push to bottom */
        .step-button-group { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; }

        /* Step Buttons */
        .step-button {
            border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600;
            border-radius: var(--border-radius); cursor: pointer; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem;
            transition: all var(--fast-transition-speed) ease; white-space: nowrap;
        }
        .step-button .icon { width: 16px; height: 16px; }
        .step-button.primary { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); color: var(--button-primary-text); box-shadow: 0 2px 8px var(--shadow-color); }
        .step-button.primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px var(--shadow-color); filter: brightness(1.1); }
        .step-button.primary:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg-tertiary); color: var(--text-tertiary); box-shadow: none; }
        .step-button.secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .step-button.secondary:hover:not(:disabled) { background-color: var(--border-color); }
        .step-button.secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .step-button.danger { background-color: transparent; color: var(--color-error); border: 1px solid var(--color-error); }
        .step-button.danger:hover:not(:disabled) { background-color: rgba(var(--color-error-dark-rgb, 244, 63, 94), 0.1); } /* Adjust RGB */
        :root[data-theme="light"] .step-button.danger:hover:not(:disabled) { background-color: rgba(var(--color-error-light-rgb, 220, 53, 69), 0.1); } /* Adjust RGB */

        /* Stepper State Styling */
        .step.step-not-recommended { opacity: var(--step-disabled-opacity); }
        .step.step-not-recommended .step-button.primary { /* Make greyed-out primary look secondary */
             background: var(--bg-tertiary); color: var(--text-tertiary); box-shadow: none;
             border: 1px solid var(--border-color);
        }
         /* Highlight for recommended step */
        .step.step-recommended { border-color: var(--border-highlight); box-shadow: 0 0 10px var(--shadow-color); }

        /* Active state */
        .step.step-active .step-indicator { background-color: var(--step-indicator-active-bg); animation: pulse-indicator 1.5s infinite ease-in-out; }
        @keyframes pulse-indicator { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step.step-active { border-color: var(--color-warning); }

        /* Complete state */
        .step.step-complete .step-indicator { background-color: var(--step-indicator-complete-bg); color: var(--step-indicator-complete-text); }
        .step.step-complete { border-color: var(--color-success); }

         /* Error state */
        .step.step-error .step-indicator { background-color: var(--step-indicator-error-bg); color: var(--step-indicator-complete-text); }
        .step.step-error { border-color: var(--color-error); }
        .step.step-error .step-status { color: var(--color-error); font-weight: 500; }

         /* Cancelled state */
        .step.step-cancelled .step-indicator { background-color: var(--step-indicator-error-bg); /* Similar to error */ color: var(--step-indicator-complete-text); }
        .step.step-cancelled { border-color: var(--color-error); /* Similar to error */ }
        .step.step-cancelled .step-status { color: var(--text-secondary); font-weight: 500; }

        /* Connector (Optional visual element) */
        .step-connector { display: none; /* Hide connectors for now, can be added back */ }

        /* --- Helper Classes --- */
        .hidden { display: none !important; }


        /* --- Icon Button Styling --- */
        .icon-button {
            background: none; border: none; padding: 0.3rem; margin: 0; cursor: pointer;
            color: var(--text-tertiary); display: inline-flex; align-items: center;
            justify-content: center; border-radius: 50%; transform: scale(1);
            transition: all var(--fast-transition-speed) ease;
        }
        .icon-button:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .icon-button .icon { stroke: currentColor; width: 18px; height: 18px; transition: stroke var(--fast-transition-speed) ease; }

        /* --- Copy Button Feedback --- */
        .copy-log-button.copied { transform: scale(1.1); }
        .copy-log-button.copied .icon { stroke: var(--color-success); }
        :root[data-theme="light"] .copy-log-button.copied .icon { stroke: var(--color-success-light); }

        /* --- Lower Section (Logs) --- */
        .lower-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .log-column { background-color: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; min-height: 350px; /* Min height */ height: auto; border: 1px solid var(--border-color); }
        .log-column h2 {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; gap: 0.5rem;
        }
        .log-column h2 span { display: flex; align-items: center; gap: 0.5rem; } /* Wraps text + icon */
        .log-column h2 .icon { width: 18px; height: 18px; stroke: var(--text-secondary); }
        .copy-log-button { margin-left: auto; }
        .item-list { list-style: none; flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; max-height: 400px; /* Max height scroll */}
        .item-list::-webkit-scrollbar { width: 6px; }
        .item-list::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .item-list::-webkit-scrollbar-thumb { background-color: var(--text-tertiary); border-radius: 3px; }
        .item-list::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        .item-list li { padding: 0.6rem 0.25rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.9rem; color: var(--text-primary); }
        .item-list li:last-child { border-bottom: none; }
        .item-list .icon { width: 16px; height: 16px; flex-shrink: 0; margin-top: 0.15em; stroke-width: 2.5; }
        .item-list .log-message { flex-grow: 1; word-break: break-word; }
        .item-list .log-message.success-summary { color: var(--accent-primary); font-weight: 500;}

        /* Status/Log specific icon colors */
        .status-icon-checking, .status-icon-loader, .status-icon-clock, .status-icon-zap { color: var(--color-warning); }
        .status-icon-new, .status-icon-play-circle { color: var(--color-success); }
        .status-icon-updated, .status-icon-warning, .status-icon-alert-circle, .status-icon-refresh-cw { color: var(--color-warning); }
        .status-icon-error, .status-icon-failed, .status-icon-alert-triangle, .status-icon-x-octagon, .status-icon-trash-2, .status-icon-x-circle, .status-icon-zap-off { color: var(--color-error); }
        .status-icon-complete, .status-icon-check-circle, .status-icon-check { color: var(--accent-primary); }
        .status-icon-info, .status-icon-chevrons-right, .status-icon-coffee, .status-icon-skipped, .status-icon-skip-forward, .status-icon-wind, .status-icon-upload-cloud { color: var(--text-tertiary); }
        .status-icon-settings, .status-icon-more-vertical, .status-icon-copy, .status-icon-list, .status-icon-align-left { color: var(--text-tertiary); }


        /* --- 3-Dot Options Menu Styling --- */
        .options-menu-container { position: relative; display: inline-block; margin-left: 0.5rem; }
        .options-menu {
            position: absolute; top: calc(100% + 5px); right: 0; background-color: var(--bg-secondary);
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0,0,0,0.08);
            z-index: 10; min-width: 220px; padding: 0.5rem 0; list-style: none; margin: 0;
            opacity: 1; visibility: visible; transform: translateY(0);
            transition: opacity var(--fast-transition-speed) ease, visibility var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease;
        }
        .options-menu.hidden { opacity: 0; visibility: hidden; transform: translateY(-5px); pointer-events: none; }
        .options-menu ul { list-style: none; padding: 0; margin: 0; }
        .options-menu li a, .options-menu li button { /* Apply to buttons too */
            display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem;
            color: var(--text-primary); text-decoration: none; font-size: 0.9rem;
            white-space: nowrap; transition: background-color var(--fast-transition-speed) ease;
            background: none; border: none; width: 100%; text-align: left; cursor: pointer;
        }
        .options-menu li a:hover, .options-menu li button:hover { background-color: var(--bg-tertiary); color: var(--accent-primary); }
        .options-menu .menu-icon { width: 16px; height: 16px; stroke-width: 2; color: var(--text-secondary); }
        .options-menu li a:hover .menu-icon, .options-menu li button:hover .menu-icon { color: var(--accent-primary); }
        .options-menu li.placeholder { padding: 0.6rem 1rem; color: var(--text-tertiary); font-style: italic; font-size: 0.9rem;}


        /* --- Responsiveness --- */
        @media (max-width: 992px) {
            .lower-section { grid-template-columns: 1fr; }
            .log-column { min-height: 300px; }
            .stepper-container { flex-direction: column; }
            .step { flex-basis: auto; } /* Let steps stack */
            .step-connector { display: none; } /* Hide connectors when stacked */
         }
        @media (max-width: 768px) {
            body { padding: 1rem 0.5rem; }
            .top-right-theme-switch { top: 0.5rem; right: 0.5rem; }
            header h1 { font-size: 1.75rem; }
            .stepper-container { gap: 0.75rem; }
            .step { padding: 1rem; }
         }
        @media (max-width: 576px) {
            html { font-size: 15px; }
            header h1 { font-size: 1.5rem; }
            .lower-section { gap: 1rem; grid-template-columns: 1fr; }
            .log-column { padding: 1rem; min-height: 250px; }
            .log-column h2 { font-size: 1.1rem; padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
            .item-list li { padding: 0.6rem 0.1rem; font-size: 0.85rem; gap: 0.5rem; }
            .step-button { padding: 0.5rem 1rem; font-size: 0.85rem; }
            .step-title { font-size: 1rem; }
            .options-menu { min-width: 180px; }
        }

        /* --- ADDED STYLES for Environment Switch & Indicator --- */

        /* Environment Indicator Chip */
        #activeEnvironmentIndicator {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 1rem; /* Pill shape */
            margin-left: 0.75rem;
            vertical-align: middle;
            text-transform: uppercase;
            transition: background-color var(--fast-transition-speed) ease, color var(--fast-transition-speed) ease;
            border: 1px solid transparent; /* For consistent sizing */
        }
        #activeEnvironmentIndicator.env-live {
            background-color: var(--color-error-dark); /* Red for live */
            color: var(--bg-primary-dark);
            border-color: var(--color-error-dark);
        }
        #activeEnvironmentIndicator.env-staging {
            background-color: var(--color-success-dark); /* Green for staging */
            color: var(--bg-primary-dark);
            border-color: var(--color-success-dark);
        }
        :root[data-theme="light"] #activeEnvironmentIndicator.env-live {
            background-color: var(--color-error-light);
             color: var(--bg-primary-light);
             border-color: var(--color-error-light);
        }
        :root[data-theme="light"] #activeEnvironmentIndicator.env-staging {
             background-color: var(--color-success-light);
             color: var(--bg-primary-light);
             border-color: var(--color-success-light);
        }

        /* Environment Switch in Menu */
        .environment-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Pushes labels apart */
            padding: 0.6rem 1rem; /* Match menu item padding */
            cursor: default; /* Container isn't clickable */
        }
        .env-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color var(--fast-transition-speed) ease;
        }
        .env-label.active {
            color: var(--text-primary);
        }
         /* Style the Staging label when active */
        #env-switch-checkbox:not(:checked) ~ .env-label-staging {
            color: var(--color-success); /* Green when staging active */
            font-weight: 600;
        }
         /* Style the Live label when active */
        #env-switch-checkbox:checked ~ .env-label-live {
             color: var(--color-error); /* Red when live active */
             font-weight: 600;
        }

        .env-switch { /* The toggle switch itself */
            position: relative;
            display: inline-block;
            width: 44px; /* Match theme switch */
            height: 22px; /* Match theme switch */
            flex-shrink: 0; /* Prevent shrinking */
            margin: 0 0.5rem; /* Space between labels and switch */
        }
        .env-switch input { display: none; }
        .env-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--color-success); /* Default green (staging) */
            transition: var(--transition-speed); border-radius: 22px;
            border: 1px solid var(--border-color);
        }
        .env-slider:before {
            position: absolute; content: ""; height: 16px; width: 16px;
            left: 3px; bottom: 2px; background-color: var(--bg-secondary);
            transition: var(--transition-speed); border-radius: 50%;
        }
        input:checked + .env-slider {
            background-color: var(--color-error); /* Red when checked (live) */
        }
        input:checked + .env-slider:before {
             transform: translateX(22px);
        }
        .env-switch input:disabled + .env-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Theme Switcher -->
        <div class="theme-switch-wrapper top-right-theme-switch">
            <i data-feather="sun" class="icon"></i>
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider"></div>
            </label>
            <i data-feather="moon" class="icon"></i>
        </div>

        <header>
            <h1>Sessions Sync Dashboard</h1>
            <p>Sync Airtable data, update website, and manage cache.
               <!-- ADDED: Environment Indicator Chip -->
               <span id="activeEnvironmentIndicator" class="env-staging">Staging</span>
            </p>
             <!-- Options Menu Container -->
             <div class="options-menu-container" style="position: absolute; top: 3.5rem; right: 1rem;">
                <button class="icon-button options-menu-button" id="optionsMenuButton" aria-label="More options">
                    <i data-feather="settings" class="icon status-icon-settings"></i>
                </button>
                <div id="optionsMenu" class="options-menu hidden">
                    <ul>
                       <!-- !!! ACTION: Replace placeholders below !!! -->
                       <li><a href="YOUR_AIRTABLE_BASE_LINK" target="_blank" rel="noopener noreferrer"><i data-feather="airplay" class="icon menu-icon"></i> Open Airtable Base</a></li>
                       <li><a href="YOUR_GOOGLE_SHEET_LINK" target="_blank" rel="noopener noreferrer"><i data-feather="grid" class="icon menu-icon"></i> Open Google Sheet</a></li>
                       <li><hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;"></li>
                       <li><button id="clearCacheMenuButton"><i data-feather="wind" class="icon menu-icon"></i> Clear Website Cache</button></li>
                       <li><button id="resetImportStatusButton"><i data-feather="zap-off" class="icon menu-icon status-icon-zap-off"></i> Reset Stuck Import Status</button></li>
                       <!-- ADDED: Environment Switch -->
                       <li><hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;"></li>
                       <li class="environment-switch-container">
                            <span class="env-label env-label-staging active">Staging</span>
                            <label class="env-switch">
                                <input type="checkbox" id="env-switch-checkbox">
                                <span class="env-slider"></span>
                            </label>
                            <span class="env-label env-label-live">Live</span>
                       </li>
                       <!-- End Environment Switch -->
                    </ul>
                </div>
            </div>
        </header>

        <!-- Stepper UI Container -->
        <section class="stepper-container">

            <!-- Step 1: Sync Sheet -->
            <div class="step step-recommended" id="step-sync">
                <div class="step-header">
                  <span class="step-indicator" id="indicator-sync">1</span>
                  <span class="step-title">Sync Sessions</span>
                </div>
                <div class="step-content">
                  <p class="step-status" id="status-sync">Ready to sync from Airtable.</p>
                  <div class="step-details" id="details-sync"></div> <!-- Sync results: X created, Y updated -->
                  <div class="step-button-group">
                      <button class="step-button primary" id="button-sync">
                          <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Sync Sessions Now</span>
                      </button>
                      <button class="step-button secondary hidden" id="button-resync">
                          <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Sync Again</span>
                      </button>
                       <button class="step-button secondary hidden" id="button-retry-sync">
                           <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Retry Sync</span>
                       </button>
                  </div>
                </div>
            </div>

            <!-- Step 2: Update Website -->
            <div class="step step-not-recommended" id="step-import">
                <div class="step-header">
                  <span class="step-indicator" id="indicator-import">2</span>
                  <span class="step-title">Update Website</span>
                </div>
                <div class="step-content">
                  <p class="step-status" id="status-import">Run 'Sync Sessions' first.</p>
                  <div class="step-details" id="details-import"></div> <!-- WP results: X created, Y updated... -->
                   <div class="step-button-group">
                      <button class="step-button primary" id="button-import">
                          <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Update Website Now</span>
                      </button>
                      <button class="step-button secondary hidden" id="button-reimport">
                          <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Update Again</span>
                       </button>
                       <button class="step-button secondary hidden" id="button-retry-import">
                           <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Retry Update</span>
                       </button>
                      <button class="step-button danger hidden" id="button-cancel-import">
                          <i data-feather="x-circle" class="icon"></i><span class="button-text">Cancel Update</span>
                      </button>
                   </div>
                </div>
            </div>

             <!-- Step 3: Clear Cache (Visually removed, functionality in menu) -->

        </section>
        <!-- End Stepper UI -->


        <!-- Log Section -->
        <section class="lower-section">
            <div class="log-column recent-activity">
                 <h2><span><i data-feather="list" class="icon status-icon-list"></i>Recent Activity</span></h2>
                <ul class="item-list" id="recent-activity-list">
                     <li><i data-feather='info' class='icon status-icon-info'></i><span class="log-message">Dashboard ready.</span></li>
                </ul>
            </div>
            <div class="log-column detailed-log">
                 <h2>
                    <span><i data-feather="align-left" class="icon status-icon-align-left"></i>Detailed Log</span>
                    <button id="copyLogButton" class="icon-button copy-log-button" aria-label="Copy detailed log">
                        <i data-feather="copy" class="icon status-icon-copy"></i>
                    </button>
                 </h2>
                <ul class="item-list" id="detailed-log-list">
                      <li><i data-feather='coffee' class='icon status-icon-coffee'></i><span class="log-message">Waiting for actions...</span></li>
                </ul>
            </div>
        </section>
        <!-- End Log Section -->
    </div>

    <!-- ============================================= -->
    <!--               JAVASCRIPT START                -->
    <!-- ============================================= -->
    <script>
        // --- Global Config Passed from GAS ---
        // Use <! ... > notation for GAS scriptlets to avoid potential conflicts
        const Logger = { log: (...args) => console.log(...args) };
        const SESSIONS_IMPORT_ID = <?= sessionsImportId ?> || null; // Get import ID passed from doGet

        // --- DOM Elements ---
        let themeCheckbox, htmlElement, copyLogButton, optionsMenuButton, optionsMenu, clearCacheMenuButton, resetImportStatusButton;
        let stepSync, indicatorSync, statusSync, detailsSync, buttonSync, buttonResync, buttonRetrySync;
        let stepImport, indicatorImport, statusImport, detailsImport, buttonImport, buttonReimport, buttonRetryImport, buttonCancelImport;
        let recentActivityList, detailedLogList;
        // --- ADDED Elements ---
        let activeEnvironmentIndicator, envSwitchCheckbox, envLabelStaging, envLabelLive;

        // --- State ---
        let currentWpRunId = null;
        let pollingIntervalId = null;
        const POLLING_INTERVAL_MS = 5000;
        let currentActiveEnvironment = 'staging'; // Default, will be updated on load

        // --- Helper Functions ---

        /** --- NEW --- Updates the visual state of the environment indicator chip and labels */
        function updateEnvironmentIndicatorUI(environment) {
             if (!activeEnvironmentIndicator || !envLabelStaging || !envLabelLive || !envSwitchCheckbox) return;

             const isLive = environment === 'live';
             activeEnvironmentIndicator.textContent = isLive ? 'Live' : 'Staging';
             activeEnvironmentIndicator.className = isLive ? 'env-live' : 'env-staging'; // Add/remove classes

             // Update label styles
             envLabelStaging.classList.toggle('active', !isLive);
             envLabelLive.classList.toggle('active', isLive);

             // Update switch state WITHOUT triggering its event listener
             // We store the *actual* state in currentActiveEnvironment
             envSwitchCheckbox.checked = isLive;

             // Update global state variable
             currentActiveEnvironment = environment;

             // Update tooltip/title for the header indicator? Optional
             activeEnvironmentIndicator.title = `Currently targeting ${environment.toUpperCase()} environment for WP actions.`;
        }

        /** --- NEW --- Handles the response from setActiveEnvironment_Server */
        function handleEnvironmentChangeSuccess(result) {
             console.log("Environment Change Result:", result);
             if (result && result.success) {
                 addActivity(`Switched target environment to ${result.newEnvironment.toUpperCase()}.`);
                 updateEnvironmentIndicatorUI(result.newEnvironment); // Update chip and labels
                 // Display message (optional, could use addActivity instead)
                 // alert(result.message);
             } else {
                 // Server reported failure
                 const message = result ? result.message : "Unknown error changing environment.";
                 addActivity(`Environment switch failed: ${message}`);
                 alert(`Failed to switch environment: ${message}\n\nUI reverted to previous state: ${result.newEnvironment.toUpperCase()}`);
                  // Revert UI to match actual server state (returned in result.newEnvironment on failure)
                  updateEnvironmentIndicatorUI(result.newEnvironment);
             }
             // Re-enable the switch
             if (envSwitchCheckbox) envSwitchCheckbox.disabled = false;
             feather.replace(); // Redraw icons if any changed (unlikely here but safe)
        }

        /** --- NEW --- Handles failure of the setActiveEnvironment_Server call itself */
        function handleEnvironmentChangeFailure(error) {
             console.error("Failed to call setActiveEnvironment_Server:", error);
             addActivity(`Error communicating environment change: ${error.message || error}`);
             alert(`Error communicating environment change: ${error.message || error}\n\nPlease check logs and try again.`);
              // Revert UI to match the known state before the failed attempt
             updateEnvironmentIndicatorUI(currentActiveEnvironment);
             // Re-enable the switch
             if (envSwitchCheckbox) envSwitchCheckbox.disabled = false;
             feather.replace();
        }

        /**
         * Updates the UI state for a specific step in the process.
         * @param {string} stepId - 'sync' or 'import'.
         * @param {string} state - 'ready', 'recommended', 'not-recommended', 'active', 'complete', 'error', 'cancelled'.
         * @param {object} [options={}] - Options: statusText, detailsHtml, activeButtonText.
         */
        function updateStepUI(stepId, state, options = {}) {
            const stepElement = document.getElementById(`step-${stepId}`);
            const indicatorElement = document.getElementById(`indicator-${stepId}`);
            const statusElement = document.getElementById(`status-${stepId}`);
            const detailsElement = document.getElementById(`details-${stepId}`);
            // Primary action buttons
            const buttonPrimary = document.getElementById(`button-${stepId}`);
            const buttonPrimaryText = buttonPrimary?.querySelector('.button-text');
            const buttonPrimaryIcon = buttonPrimary?.querySelector('.icon');
            // Secondary/alternate action buttons (Get references specific to the step)
            const buttonResync = stepId === 'sync' ? document.getElementById('button-resync') : null;
            const buttonRetrySync = stepId === 'sync' ? document.getElementById('button-retry-sync') : null;
            const buttonReimport = stepId === 'import' ? document.getElementById('button-reimport') : null;
            const buttonRetryImport = stepId === 'import' ? document.getElementById('button-retry-import') : null;
            const buttonCancelImport = stepId === 'import' ? document.getElementById('button-cancel-import') : null;

            if (!stepElement || !indicatorElement || !statusElement || !detailsElement) {
                console.error(`UI elements not found for step: ${stepId}`);
                return;
            }

            // 1. Reset state classes & hide optional buttons
            stepElement.classList.remove('step-ready', 'step-recommended', 'step-not-recommended', 'step-active', 'step-complete', 'step-error', 'step-cancelled');
            indicatorElement.innerHTML = stepId === 'sync' ? '1' : (stepId === 'import' ? '2' : '?'); // Reset indicator
            if (buttonPrimary) {
                 buttonPrimary.disabled = false;
                 buttonPrimary.classList.remove('hidden'); // Ensure primary button is visible initially
            }
             // Hide all secondary buttons by default
            [buttonResync, buttonRetrySync, buttonReimport, buttonRetryImport, buttonCancelImport].forEach(btn => btn?.classList.add('hidden'));

             // Apply default button text and icon based on stepId
             if (buttonPrimaryText && buttonPrimaryIcon) {
                 if (stepId === 'sync') {
                     buttonPrimaryText.textContent = 'Sync Sessions Now';
                     buttonPrimaryIcon.setAttribute('data-feather', 'refresh-cw');
                 } else if (stepId === 'import') {
                     buttonPrimaryText.textContent = 'Update Website Now';
                     buttonPrimaryIcon.setAttribute('data-feather', 'upload-cloud');
                 }
             }

            // 2. Apply new state class
            stepElement.classList.add(`step-${state}`);

            // 3. Update Status Text
            if (options.statusText !== undefined) statusElement.textContent = options.statusText;

            // 4. Update Details HTML
            if (options.detailsHtml !== undefined) detailsElement.innerHTML = options.detailsHtml;
            else detailsElement.innerHTML = ''; // Clear details if not provided

            // 5. Handle State-Specific UI Changes
            switch (state) {
                case 'ready':
                    // Default state - primary button enabled
                    break;
                case 'recommended':
                    // Highlight applied by class
                    break;
                case 'not-recommended':
                    // Grey-out applied by class
                    break;
                case 'active':
                    if (buttonPrimary) buttonPrimary.disabled = true;
                    if (buttonPrimaryText) buttonPrimaryText.textContent = options.activeButtonText || 'Processing...';
                    indicatorElement.innerHTML = `<i data-feather="loader" class="icon"></i>`; // Spinner
                    // Show cancel button only for import step during active state
                    if (stepId === 'import' && buttonCancelImport) buttonCancelImport.classList.remove('hidden');
                    break;
                case 'complete':
                    if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide primary button
                    indicatorElement.innerHTML = `<i data-feather="check" class="icon"></i>`; // Checkmark
                    // Show appropriate "Re-run" button
                    if (buttonResync) buttonResync.classList.remove('hidden');
                    if (buttonReimport) buttonReimport.classList.remove('hidden');
                    break;
                case 'error':
                    if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide primary button
                    indicatorElement.innerHTML = `<i data-feather="x" class="icon"></i>`; // Cross
                     // Show appropriate "Retry" button
                    if (buttonRetrySync) buttonRetrySync.classList.remove('hidden');
                    if (buttonRetryImport) buttonRetryImport.classList.remove('hidden');
                    break;
                case 'cancelled': // Specific state for import
                     if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide primary button
                     indicatorElement.innerHTML = `<i data-feather="x-circle" class="icon"></i>`; // Cancel icon
                     if (buttonReimport) buttonReimport.classList.remove('hidden'); // Allow re-run
                     break;
                 default:
                    // Ensure primary enabled by default if state is unknown
                    if (buttonPrimary) buttonPrimary.disabled = false;
            }

            feather.replace(); // Update icons
        }

        /** Adds a log entry (as HTML string) to the detailed log list */
        function addLog(htmlContent) {
            if (!detailedLogList || !htmlContent) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent; // Assumes htmlContent is like "<li>...</li>"
            if (tempDiv.firstChild) {
                 // Insert at top, limit total items for performance
                 if (detailedLogList.children.length >= 200) {
                    detailedLogList.removeChild(detailedLogList.lastChild);
                 }
                detailedLogList.prepend(tempDiv.firstChild);
            }
        }

        /** Adds an activity summary (plain text) to the recent activity list */
        function addActivity(text) {
             if (!recentActivityList || !text) return;
             let icon = 'info'; let iconClass = 'status-icon-info';
             const lowerText = String(text).toLowerCase();

             // Determine icon based on keywords (more specific)
             if (lowerText.includes('sync complete') || lowerText.includes('update complete') || lowerText.includes('cache cleared')) { icon = 'check-circle'; iconClass = 'status-icon-complete'; }
             else if (lowerText.includes('started sync') || lowerText.includes('started cache clear')) { icon = 'loader'; iconClass = 'status-icon-checking'; }
             else if (lowerText.includes('monitoring started') || lowerText.includes('checking status')) { icon = 'clock'; iconClass = 'status-icon-checking'; }
             else if (lowerText.includes('website update already running') || lowerText.includes('website update in progress') || lowerText.includes('processing')) { icon = 'zap'; iconClass = 'status-icon-checking'; }
             else if (lowerText.includes('failed') || lowerText.includes('error')) { icon = 'alert-triangle'; iconClass = 'status-icon-error'; }
             else if (lowerText.includes('cancelled')) { icon = 'x-circle'; iconClass = 'status-icon-error'; } // Treat cancel like error visually here
             else if (lowerText.includes('manual status reset')) { icon = 'zap-off'; iconClass = 'status-icon-warning'; }

             const li = document.createElement('li');
             li.innerHTML = `<i data-feather='${icon}' class='icon ${iconClass}'></i><span class="log-message">${text}</span>`;

             // Insert at top, limit total items
             if (recentActivityList.children.length >= 50) {
                 recentActivityList.removeChild(recentActivityList.lastChild);
             }
             recentActivityList.prepend(li);
             feather.replace({ width: 16, height: 16 }); // Redraw icons in list
        }

        /** Formats an ISO timestamp for display */
        function formatDisplayTimestamp(isoTimestamp) {
            if (!isoTimestamp) return 'Never';
            try {
                // Attempt to use locale formatting for better readability
                return new Date(isoTimestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
            } catch (e) {
                // Fallback for potential invalid dates
                 return isoTimestamp.substring(0, 10); // Show YYYY-MM-DD at least
            }
        }

        /** Clears both log lists */
        function clearLogs() {
            if (recentActivityList) recentActivityList.innerHTML = '';
            if (detailedLogList) detailedLogList.innerHTML = '';
        }

        /** Formats duration in milliseconds to seconds or ms */
        function formatDuration(ms) {
             if (ms === undefined || ms === null || ms < 0) return '--';
             if (ms < 1000) return `${ms}ms`;
             return `${(ms / 1000).toFixed(1)}s`;
        }

        /** Formats counter object into a string.
         *  Assumes input object uses keys: created, updated, deleted, skipped
         *  (Handles both sheet sync and import cache results structures)
         */
        function formatCounters(counters) {
            if (!counters) return 'N/A'; // Return N/A if no counter object
            let parts = [];
            // Directly access the keys expected from either source (sheet sync OR import cache)
            // Use nullish coalescing (??) to safely handle potentially missing keys, default to 0
            const created = counters.created ?? counters.posts_created ?? 0;
            const updated = counters.updated ?? counters.posts_updated ?? 0;
            const deleted = counters.deleted ?? counters.posts_deleted ?? 0;
            const skipped = counters.skipped ?? counters.posts_skipped ?? 0;

            if (created > 0) parts.push(`${created} created`);
            if (updated > 0) parts.push(`${updated} updated`);
            if (deleted > 0) parts.push(`${deleted} removed`);
            if (skipped > 0) parts.push(`${skipped} skipped`);

            if (parts.length === 0 && (created === 0 && updated === 0 && deleted === 0 && skipped >= 0)) {
                // Explicitly state "No changes" if counts are zero or only skipped > 0
                return 'No changes.';
            } else if (parts.length > 0) {
                return parts.join(', ');
            } else {
                // Fallback if the counters object was present but empty/unrecognized
                return 'Stats N/A';
            }
        }

         /** Shows visual feedback on the copy button */
        function showCopySuccessFeedback() {
            if (!copyLogButton) return;
            copyLogButton.classList.add('copied');
            setTimeout(() => { if (copyLogButton) copyLogButton.classList.remove('copied'); }, 1500);
        }

        /** Fallback copy method using execCommand */
        function tryExecCommandCopy(textToCopy) {
            const textArea = document.createElement("textarea");
            // Basic styling to prevent visual interference
            textArea.style.position = 'fixed'; textArea.style.top = '-9999px'; textArea.style.left = '-9999px';
            textArea.style.width = '2em'; textArea.style.height = '2em'; textArea.style.padding = '0';
            textArea.style.border = 'none'; textArea.style.outline = 'none'; textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';

            textArea.value = textToCopy; document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            let success = false;
            try {
                success = document.execCommand('copy');
                if (success) { showCopySuccessFeedback(); } else { alert("Fallback copy failed. Please copy manually."); }
            } catch (err) { alert("Error using fallback copy method: " + err); }
            finally { document.body.removeChild(textArea); }
            return success;
        }

        /** Capitalizes the first letter of a string */
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }


        // --- Polling Functions ---

        /** Starts polling the WP import status */
        function startPollingWpStatus(importId) {
            if (pollingIntervalId) clearInterval(pollingIntervalId); // Clear previous interval if any
            if (!importId) {
                 console.error("Cannot start polling without Import ID.");
                 return;
            }

            console.log(`Polling WP status starting for import ID: ${importId}`);
            // Initial immediate check
            google.script.run
                 .withSuccessHandler(handleWpImportStatusUpdate)
                 .withFailureHandler(handlePollingFailure)
                 .getImportStatus(importId);

            // Set interval for subsequent checks
            pollingIntervalId = setInterval(() => {
                console.log("Polling WP status check for import ID:", importId);
                google.script.run
                    .withSuccessHandler(handleWpImportStatusUpdate)
                    .withFailureHandler(handlePollingFailure)
                    .getImportStatus(importId);
            }, POLLING_INTERVAL_MS);
        }

        /** Stops the polling interval */
        function stopPollingWpStatus() {
             if (pollingIntervalId) {
                 clearInterval(pollingIntervalId);
                 pollingIntervalId = null;
                 console.log("Polling stopped.");
             }
        }


        // --- Server Call Handlers ---

        /** Handles the result of runSheetSync_Dashboard */
        function handleSheetSyncResult(result) {
            console.log("Sheet Sync Result:", result);

            // Add Logs from this specific run
            result.lastSyncResults?.logs?.forEach(logItem => addLog(logItem));

            // Add Summary Message to Recent Activity
            result.lastSyncResults?.recentItems?.forEach(activityItem => addActivity(activityItem));

            // Update Step 1 (Sync) UI
            const syncCounters = result.lastSyncResults?.typeCounters?.sessions || {};
            const duration = result.lastSyncDuration;
            const syncSuccess = result.success;

            if (syncSuccess) {
                 updateStepUI('sync', 'complete', {
                     statusText: `Sync Complete (${formatDuration(duration)}).`,
                     detailsHtml: formatCounters(syncCounters)
                 });
                 // Recommend Step 2 (Import)
                 updateStepUI('import', 'recommended', {
                     statusText: 'Ready to update website.'
                 });
            } else {
                const errorMsg = result.error || "Unknown sync error.";
                 updateStepUI('sync', 'error', {
                     statusText: `Sync Failed: ${errorMsg}`
                 });
                 // Keep Step 2 Not Recommended
                 updateStepUI('import', 'not-recommended', {
                     statusText: "Run 'Sync Sessions' successfully first."
                 });
            }

            // Update Cache Clear button state (enabled if import step is complete)
            const importStepElement = document.getElementById('step-import');
             if (clearCacheMenuButton) {
                 clearCacheMenuButton.disabled = !(importStepElement?.classList.contains('step-complete'));
             }
             feather.replace();
        }


                /** Handles the result of initiateWordPressImport */
        function handleWpImportInitiationResult(result) {
            console.log("WP Import Initiation Result:", result);
            result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon status-icon-info'></i><span class="log-message">${logLine}</span></li>`)); // Add logs from the trigger function

            if (result.success) {
                // Trigger was sent successfully OR timed out (assume it might have worked)
                // Update UI to show active/waiting state and start polling
                let statusText = 'Waiting for server processing...';
                if (result.status === 'already_active') {
                    statusText = 'Website update already active. Monitoring status...';
                } else if (result.status === 'trigger_timeout_error') {
                    statusText = 'Trigger request timed out. Monitoring status...';
                } else {
                    // Default for triggered_waiting
                    statusText = 'Trigger sent. Waiting for server processing...';
                }

                updateStepUI('import', 'active', {
                    statusText: statusText,
                    activeButtonText: 'Processing...' // Standard active text
                });
                addActivity(result.message || statusText); // Use message from server or the derived statusText
                startPollingWpStatus(SESSIONS_IMPORT_ID); // Start polling the Handler cache

            } else {
                // Trigger failed (WP error, HTTP error, fetch error)
                updateStepUI('import', 'error', {
                    statusText: `Update Failed to Start: ${result.message || 'Unknown trigger error.'}`
                });
                addActivity(`Website Update Trigger Failed: ${result.message || 'Unknown trigger error.'}`);
                stopPollingWpStatus(); // Don't poll if trigger failed
                currentWpRunId = null; // Reset just in case
                // Optional: Re-enable Sync step if it was disabled? Depends on desired flow.
                // updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
            }
            feather.replace(); // Ensure icons update
        }


        /** Handles polled status updates from getImportStatus */
        function handleWpImportStatusUpdate(statusResult) {
            console.log("WP Import Status Update Received:", statusResult);
            if (!statusResult) {
                console.warn("Received null status update during polling.");
                 updateStepUI('import', 'active', { // Keep active but show uncertainty
                     statusText: 'Checking status... (Waiting for response)'
                 });
                 addActivity("Checking website update status... (Waiting for response)");
                return;
            }

            // Optional: Add check against currentWpRunId if needed, but less critical now
            // if (currentWpRunId && statusResult.runId && statusResult.runId !== currentWpRunId) { ... }

            switch (statusResult.status) {
                case 'pending':
                case 'processing': // Treat processing the same as pending visually
                case 'triggered': // Treat triggered the same as pending visually
                     updateStepUI('import', 'active', {
                         statusText: statusResult.message || 'Website update is processing...',
                         activeButtonText: 'Processing...'
                     });
                     // Reduce redundant activity logs during polling if message is the same? Optional.
                     // if(statusElement.textContent !== statusResult.message) { addActivity(statusResult.message || "Website update in progress..."); }
                    break;
                case 'complete':
                    Logger.log("Polling received 'complete' status. Finalizing UI."); // Add log
                    // ** NEW: Explicitly call the completion handler with the final data **
                    handleWpImportCompletion(statusResult);
                    // Now stop polling AFTER the UI has been updated with final numbers
                    stopPollingWpStatus();
                    break; // Keep the break statement
                case 'failed': // Explicit failure from WP All Import (e.g., via hook data)
                     stopPollingWpStatus();
                     handleWpImportFailure(statusResult);
                     break;
                case 'error': // Error reported by getImportStatus itself (e.g., library call failure)
                     stopPollingWpStatus();
                     handleWpImportFailure(statusResult); // Treat library errors as failure for UI
                     break;
                case 'cancelled': // Status explicitly set to cancelled
                    stopPollingWpStatus();
                    handleWpImportCancellation(statusResult);
                    break;
                 case 'unknown': // e.g. cache miss after pending, or initial state
                     updateStepUI('import', 'active', { // Keep active visually, but indicate potential issue
                         statusText: 'Checking status... (Cache status unknown)',
                         activeButtonText: 'Processing...'
                     });
                     addActivity("Checking website update status... (Status unknown)");
                     break;
                 case 'not_configured': // Should only happen on initial load, but handle defensively
                     stopPollingWpStatus();
                      updateStepUI('import', 'error', {
                           statusText: 'Website Update not configured.',
                           detailsHtml: ''
                       });
                       if(buttonImport) buttonImport.disabled = true;
                       break;
                default: // Any other status or unexpected value
                    console.warn("Unknown WP import status received during polling:", statusResult.status);
                    // Keep polling but don't flood logs
                    updateStepUI('import', 'active', {
                         statusText: `Processing... (Status: ${statusResult.status || 'N/A'})`,
                         activeButtonText: 'Processing...'
                     });
            }
        }
        /** Handles successful completion */
        function handleWpImportCompletion(statusResult) {
            // Debug: Log the raw data received from the poll
            console.log("WP Import Complete - Data received by UI:", statusResult);

            // Calculate Details using the received statusResult
            const details = statusResult ? formatCounters(statusResult) : 'Details unavailable.';

            // Calculate Duration correctly from Unix seconds
            const duration = (statusResult && statusResult.startTime && statusResult.endTime && typeof statusResult.startTime === 'number' && typeof statusResult.endTime === 'number')
                                // Multiply by 1000 to convert Unix seconds to milliseconds for Date object
                                ? formatDuration( (new Date(statusResult.endTime * 1000).getTime()) - (new Date(statusResult.startTime * 1000).getTime()) )
                                : ''; // Calculate duration from Unix seconds - Removed extra ": ''"

            // Debug: Log the calculated duration and formatted details string
            console.log("WP Import Complete - Calculated Duration:", duration);
            console.log("WP Import Complete - Formatted Import Details:", details);

            // Update Step 2 UI
            updateStepUI('import', 'complete', {
                statusText: `Website Update Complete ${duration ? `(${duration})` : ''}.`,
                detailsHtml: details + '<br/>Cache clear recommended.' // Display the correct details
            });

            // Update Activity Log
            addActivity("Website Update Complete.");

            // Clear State Variables
            currentWpRunId = null;

            // Enable Cache Clear Button
            if (clearCacheMenuButton) {
                clearCacheMenuButton.disabled = false;
            }

            // Make Sync Step Recommended Again
            // Preserve existing details in Step 1 if possible
            const lastSyncDetailsElement = document.getElementById('details-sync');
            const syncDetailsHtml = lastSyncDetailsElement ? lastSyncDetailsElement.innerHTML : '';
            updateStepUI('sync', 'recommended', {
                statusText: 'Ready to sync.',
                detailsHtml: syncDetailsHtml // Keep previous sync details
            });

            // Refresh Icons
            feather.replace();
        }

        /** Handles failed import */
         function handleWpImportFailure(statusResult) {
             console.error("WP Import Failed:", statusResult);
             const errorMsg = statusResult?.message || 'Unknown error during update.';
             updateStepUI('import', 'error', {
                 statusText: `Website Update Failed: ${errorMsg}`
             });
             addActivity(`Website Update Failed: ${errorMsg}`);
             stopPollingWpStatus();
             currentWpRunId = null;

             // Make Sync Step Recommended again
             updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
             // Keep cache clear disabled on failure
             if (clearCacheMenuButton) clearCacheMenuButton.disabled = true;
             feather.replace();
         }

        /** Handles polling failure (network etc) */
        function handlePollingFailure(error) {
             console.error("Polling Failure:", error);
             // Don't stop polling immediately, maybe transient error
             updateStepUI('import', 'active', {
                 statusText: 'Error checking status... Retrying.',
                 activeButtonText: 'Processing...'
             });
             addActivity("Error checking website update status.");
             // Consider adding a counter to stop polling after N consecutive errors
         }

        /** Handles explicit cancellation */
        function handleWpImportCancellation(statusResult) {
            console.log("WP Import Cancelled:", statusResult);
            const cancelMsg = statusResult?.message || 'Update cancelled.';
            updateStepUI('import', 'cancelled', {
                 statusText: `Website Update Cancelled. ${cancelMsg}`
            });
            addActivity(`Website Update Cancelled.`);
            stopPollingWpStatus();
            currentWpRunId = null;

            // Make Sync Step Recommended again
             updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
             // Keep cache clear disabled after cancellation
             if (clearCacheMenuButton) clearCacheMenuButton.disabled = true;
             feather.replace();
        }

        /** Handles result from cancelWordPressImport */
        function handleCancelResult(result) {
             console.log("Cancel Result:", result);
             result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon status-icon-info'></i><span class="log-message">${logLine}</span></li>`));

             // Re-enable cancel button regardless of success/fail? Or only on fail? Let's re-enable.
             if(buttonCancelImport) {
                 buttonCancelImport.disabled = false;
                 buttonCancelImport.querySelector('.button-text').textContent = 'Cancel Update';
             }

             if (result.success) {
                 // Let the next polling cycle pick up the actual cancelled status if WP changed it,
                 // or just update the UI immediately for responsiveness. Immediate update is better.
                 handleWpImportCancellation({ status: 'cancelled', message: result.message || 'Cancellation request sent.' });
             } else {
                  const errorMsg = result.message || "Failed to send cancel request.";
                  updateStepUI('import', 'active', { // Keep active visually, but show error briefly
                       statusText: `Cancel request failed: ${errorMsg}. Re-checking status...`,
                       activeButtonText: 'Processing...'
                  });
                  addActivity(`Cancel request failed: ${errorMsg}`);
                  // Do NOT stop polling here if cancel failed - it might still be running.
             }
             feather.replace();
        }

        /** Handles result from clearBreezeCache */
        function handleCacheClearResult(result) {
             console.log("Cache Clear Result:", result);
             result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon status-icon-info'></i><span class="log-message">${logLine}</span></li>`));

             // Re-enable the button in the options menu
             if(clearCacheMenuButton) clearCacheMenuButton.disabled = false;

             if (result.success) {
                 addActivity("Website Cache Cleared Successfully.");
                 // Update the details of the import step to remove the recommendation?
                 const importDetails = document.getElementById('details-import');
                 if (importDetails) {
                    // Remove the specific "Cache clear recommended" text if present
                    importDetails.innerHTML = importDetails.innerHTML.replace('<br>Cache clear recommended.', '');
                 }
             } else {
                  addActivity(`Cache Clear Failed: ${result.message}`);
                  alert(`Cache Clear Failed: ${result.message}`); // Show alert for this action
             }
             feather.replace();
        }

        /** Handles result from clearSpecificImportCache */
        function handleClearImportStatusResult(result) {
            console.log("Clear Import Status Result:", result);
            if (result && result.success) {
                alert(`Success: ${result.message}`);
                addActivity(`Manual status reset for Import ID ${SESSIONS_IMPORT_ID} successful.`);
                // Refresh the dashboard state to reflect the change
                stopPollingWpStatus(); // Ensure polling is stopped if it was running
                currentWpRunId = null; // Clear tracked run ID
                // Fetch the latest data to update the entire UI correctly
                addLog("<li><i data-feather='refresh-cw' class='icon status-icon-info'></i><span class='log-message'>Refreshing dashboard data after manual status reset...</span></li>");
                feather.replace();
                google.script.run
                     .withSuccessHandler(updateDashboardInitial)
                     .withFailureHandler((err) => {
                          console.error("Failed to reload data after cache clear:", err);
                          addLog(`<li><i data-feather='alert-triangle' class='icon status-icon-error'></i><span class='log-message'>Error reloading dashboard status after reset: ${err.message || err}</span></li>`);
                     })
                     .getDashboardData();
            } else {
                const errorMsg = result ? result.message : "Unknown error occurred.";
                alert(`Error: ${errorMsg}`);
                addActivity(`Manual status reset for Import ID ${SESSIONS_IMPORT_ID} failed: ${errorMsg}`);
            }
        }


        /** Populates the dashboard with initial data on load */
        function updateDashboardInitial(data) {
            console.log("Initial Data Received:", data);
            clearLogs();
            addLog("<li><i data-feather='info' class='icon status-icon-info'></i><span class='log-message'>Dashboard loaded. Checking initial states...</span></li>");

            // --- ADDED: Update Environment Indicator & Switch ---
            if (data.activeEnvironment) {
                 updateEnvironmentIndicatorUI(data.activeEnvironment);
            } else {
                 console.warn("Initial data did not include activeEnvironment. Defaulting UI to Staging.");
                 updateEnvironmentIndicatorUI('staging'); // Default if missing
            }
            // --- END ADDED ---

            const lastSyncStatus = data.lastSyncStatus;
            const lastSyncTime = data.lastSyncTimestamp;
            const lastSyncDuration = data.lastSyncDuration;
            const syncCounters = data.lastSyncResults?.typeCounters?.sessions || {};
            const wpStatusData = data.wpImportStatus; // Object like { status: 'pending'/'complete'/'error', ... }

            // Determine if WP Import is currently active based on handler status
            let wpIsActive = wpStatusData &&
                             (wpStatusData.status === 'pending' ||
                              wpStatusData.status === 'processing' ||
                              wpStatusData.status === 'triggered');

            // --- Set Initial Step States ---

            // Handle Active WP Import FIRST
            if (wpIsActive) {
                console.log("Initial state: WP Import is active/pending. Starting polling.");
                // Update Step 2 (Import) UI
                updateStepUI('import', 'active', {
                    statusText: wpStatusData.message || 'Website update in progress...',
                    activeButtonText: 'Processing...'
                });
                currentWpRunId = wpStatusData.runId || null; // Store ID if available
                startPollingWpStatus(SESSIONS_IMPORT_ID); // Start polling

                // Update Step 1 (Sync) UI - Show historical data but NOT recommended
                const syncHistoryIcon = lastSyncStatus === 'Success' ? 'check' : (lastSyncStatus === 'Failed' ? 'x' : 'minus');
                const syncHistoryDetails = `Last: ${formatDisplayTimestamp(lastSyncTime)} <i data-feather="${syncHistoryIcon}" class="icon" style="width:12px; height:12px;"></i> ${formatCounters(syncCounters)} (${formatDuration(lastSyncDuration)})`;
                // Set state based on historical success/fail but keep status text indicating import is running
                updateStepUI('sync', lastSyncStatus === 'Success' ? 'complete' : (lastSyncStatus === 'Failed' ? 'error' : 'ready'), {
                    statusText: `Website update in progress... Sync disabled.`,
                    detailsHtml: lastSyncStatus !== 'Never Run' ? syncHistoryDetails : ''
                });
                // Disable primary sync button while import runs
                 if (buttonSync) buttonSync.disabled = true;


            } else {
                // WP Import is NOT active - Default to recommending Sync
                console.log("Initial state: WP Import not active. Recommending Sync.");
                stopPollingWpStatus(); // Ensure no polling is running initially

                // Step 1: Sync - Recommended, show last run details
                const syncHistoryIcon = lastSyncStatus === 'Success' ? 'check' : (lastSyncStatus === 'Failed' ? 'x' : 'minus');
                const syncHistoryDetails = `Last: ${formatDisplayTimestamp(lastSyncTime)} <i data-feather="${syncHistoryIcon}" class="icon" style="width:12px; height:12px;"></i> ${formatCounters(syncCounters)} (${formatDuration(lastSyncDuration)})`;
                updateStepUI('sync', 'recommended', {
                    statusText: 'Ready to sync sessions.',
                    detailsHtml: lastSyncStatus !== 'Never Run' ? syncHistoryDetails : 'No previous sync data.'
                });

                // Step 2: Import - Not recommended initially, show last run details
                let importStatusText = "Run 'Sync Sessions' first.";
                let importDetailsHtml = '';
                let importInitialState = 'not-recommended';

                if (wpStatusData) {
                    // Display details of the LAST completed/failed/cancelled import
                    if (wpStatusData.status === 'complete' || wpStatusData.status === 'failed' || wpStatusData.status === 'cancelled') {
                         const importHistoryIcon = wpStatusData.status === 'complete' ? 'check' : 'x';
                         const importTimestamp = wpStatusData.libraryCheckTime || (wpStatusData.endTime ? new Date(wpStatusData.endTime * 1000).toISOString() : null); // Use check time or end time
                         importDetailsHtml = `Last: ${formatDisplayTimestamp(importTimestamp)} <i data-feather="${importHistoryIcon}" class="icon" style="width:12px; height:12px;"></i> ${formatCounters(wpStatusData)}`;
                         if (wpStatusData.status === 'complete') importStatusText = 'Website update complete. Sync recommended.'; // Update status text if last was complete
                         else if (wpStatusData.status === 'failed') importStatusText = 'Last update failed. Run Sync first.';
                         else if (wpStatusData.status === 'cancelled') importStatusText = 'Last update cancelled. Run Sync first.';
                         // Keep state 'not-recommended' until sync is run again
                    } else if (wpStatusData.status === 'unknown') {
                         importStatusText = 'No previous update status found. Run Sync first.';
                         importInitialState = 'not-recommended';
                    } else if (wpStatusData.status === 'not_configured') {
                        importInitialState = 'error';
                        importStatusText = 'Website Update not configured.';
                        if(buttonImport) buttonImport.disabled = true; // Disable button if not configured
                    }
                }

                updateStepUI('import', importInitialState, {
                    statusText: importStatusText,
                    detailsHtml: importDetailsHtml
                });
            }

            // Set initial state of Cache Clear menu item (enabled ONLY if last WP import was complete)
            if (clearCacheMenuButton) {
                 clearCacheMenuButton.disabled = !(wpStatusData && wpStatusData.status === 'complete');
            }

            // Populate Logs from last stored run (sheet sync only initially stored)
            data.lastSyncResults?.logs?.forEach(logItem => addLog(logItem));
            data.lastSyncResults?.recentItems?.forEach(activityItem => addActivity(activityItem));

            addLog("<li><i data-feather='check-circle' class='icon status-icon-complete'></i><span class='log-message'>Initial status check complete.</span></li>");
            feather.replace(); // Render all icons
        }


        // --- Initial Load and Event Listener Assignment ---
        window.addEventListener('load', () => {
            console.log("Dashboard loaded.");

            // Assign DOM Elements
            themeCheckbox = document.getElementById('theme-checkbox');
            htmlElement = document.documentElement;
            copyLogButton = document.getElementById('copyLogButton');
            optionsMenuButton = document.getElementById('optionsMenuButton');
            optionsMenu = document.getElementById('optionsMenu');
            clearCacheMenuButton = document.getElementById('clearCacheMenuButton');
            resetImportStatusButton = document.getElementById('resetImportStatusButton'); // Added

            // Step 1 Elements
            stepSync = document.getElementById('step-sync');
            indicatorSync = document.getElementById('indicator-sync');
            statusSync = document.getElementById('status-sync');
            detailsSync = document.getElementById('details-sync');
            buttonSync = document.getElementById('button-sync');
            buttonResync = document.getElementById('button-resync');
            buttonRetrySync = document.getElementById('button-retry-sync');

            // Step 2 Elements
            stepImport = document.getElementById('step-import');
            indicatorImport = document.getElementById('indicator-import');
            statusImport = document.getElementById('status-import');
            detailsImport = document.getElementById('details-import');
            buttonImport = document.getElementById('button-import');
            buttonReimport = document.getElementById('button-reimport');
            buttonRetryImport = document.getElementById('button-retry-import');
            buttonCancelImport = document.getElementById('button-cancel-import');

            // Log Elements
            recentActivityList = document.getElementById('recent-activity-list');
            detailedLogList = document.getElementById('detailed-log-list');

            // --- ADDED: Assign Environment Switch Elements ---
            activeEnvironmentIndicator = document.getElementById('activeEnvironmentIndicator');
            envSwitchCheckbox = document.getElementById('env-switch-checkbox');
            envLabelStaging = document.querySelector('.env-label-staging');
            envLabelLive = document.querySelector('.env-label-live');

            // Basic check for essential elements
            if (!buttonSync || !buttonImport || !themeCheckbox || !copyLogButton || !optionsMenuButton || !optionsMenu || !clearCacheMenuButton || !resetImportStatusButton
               || !activeEnvironmentIndicator || !envSwitchCheckbox || !envLabelStaging || !envLabelLive // ADDED check
            ) {
                console.error("CRITICAL ERROR: Failed to find essential UI elements on load.");
                alert("Dashboard UI failed to load correctly. Please refresh or contact support.");
                return;
            }

            // --- Attach Event Listeners ---

            // Step 1: Sync (All buttons trigger the same action)
            [buttonSync, buttonResync, buttonRetrySync].forEach(btn => {
                btn?.addEventListener('click', () => {
                    // Disable other sync buttons immediately
                    [buttonSync, buttonResync, buttonRetrySync].forEach(b => { if(b && b !== btn) b.disabled = true; });
                    updateStepUI('sync', 'active', { statusText: 'Syncing sessions...', activeButtonText: 'Syncing...' });
                    addActivity("Started Session Sync.");
                    google.script.run
                        .withSuccessHandler(handleSheetSyncResult)
                        .withFailureHandler(handleSheetSyncResult) // Use same handler, check result.success
                        .runSheetSync_Dashboard();
                });
            });

            // Step 2: Import (Trigger Import on WP)
            [buttonImport, buttonReimport, buttonRetryImport].forEach(btn => {
                btn?.addEventListener('click', () => {
                    if (!SESSIONS_IMPORT_ID) {
                        alert("Error: Website Update Import ID is not configured.");
                        return;
                    }
                    // Disable other import buttons immediately
                    [buttonImport, buttonReimport, buttonRetryImport].forEach(b => { if(b && b !== btn) b.disabled = true; });

                    // 1. Update UI to an intermediate "Preparing..." state
                    updateStepUI('import', 'active', { statusText: 'Preparing update...', activeButtonText: 'Preparing...' });
                    addActivity(`Preparing to update website (ID: ${SESSIONS_IMPORT_ID}). Clearing previous status...`);
                    stopPollingWpStatus(); // Ensure no old polling is running

                    // 2. Call server to clear the handler's cache for this import ID
                    google.script.run
                        .withSuccessHandler(function(clearResult) {
                            console.log("Pre-emptive cache clear result for import handler:", clearResult);
                            if (clearResult && clearResult.success) {
                                addActivity(`Previous status for ID ${SESSIONS_IMPORT_ID} cleared from handler. Triggering WP import...`);
                            } else {
                                // Log a warning but proceed. The import might still work, or the cache was already clear.
                                addActivity(`Warning: Could not clear previous handler status for ID ${SESSIONS_IMPORT_ID}: ${clearResult?.message || 'Unknown clear error'}. Proceeding with trigger...`);
                            }

                            // 3. NOW, trigger the WordPress import
                            updateStepUI('import', 'active', { statusText: 'Sending trigger request to WP...', activeButtonText: 'Triggering...' });

                            google.script.run
                                .withSuccessHandler(handleWpImportInitiationResult) // This handler starts polling on success
                                .withFailureHandler(handleWpImportInitiationResult) // Check result.success
                                .initiateWordPressImport(SESSIONS_IMPORT_ID);
                        })
                        .withFailureHandler(function(error) {
                            console.error("Failed to call clearSpecificImportCache (pre-import):", error);
                            addActivity(`Error clearing previous handler status: ${error.message || error}. Attempting WP trigger anyway...`);
                            // Proceed with trigger even if pre-emptive clear fails on the GAS side
                            updateStepUI('import', 'active', { statusText: 'Sending trigger request to WP (after clear error)...', activeButtonText: 'Triggering...' });
                            google.script.run
                                .withSuccessHandler(handleWpImportInitiationResult)
                                .withFailureHandler(handleWpImportInitiationResult)
                                .initiateWordPressImport(SESSIONS_IMPORT_ID);
                        })
                        .clearSpecificImportCache(SESSIONS_IMPORT_ID); // This calls the Lib function in ImportHandler
                });
            });

            // Step 2: Cancel Import
            buttonCancelImport?.addEventListener('click', () => {
                if (!SESSIONS_IMPORT_ID) {
                    alert("Error: Website Update Import ID is not configured.");
                    return;
                }
                if (!confirm("Are you sure you want to attempt to cancel the current website update?")) return;

                buttonCancelImport.disabled = true;
                buttonCancelImport.querySelector('.button-text').textContent = 'Cancelling...';
                addActivity("Sending cancel request for website update...");

                google.script.run
                    .withSuccessHandler(handleCancelResult)
                    .withFailureHandler(handleCancelResult) // Check result.success
                    .cancelWordPressImport(SESSIONS_IMPORT_ID);
            });

            // Options Menu: Clear Cache
            clearCacheMenuButton?.addEventListener('click', () => {
                if(clearCacheMenuButton.disabled) return;
                clearCacheMenuButton.disabled = true;
                addActivity("Started Website Cache Clear.");
                optionsMenu.classList.add('hidden'); // Close menu

                google.script.run
                    .withSuccessHandler(handleCacheClearResult)
                    .withFailureHandler(handleCacheClearResult) // Check result.success
                    .clearBreezeCache();
            });

            // Options Menu: Reset Stuck Import Status
            resetImportStatusButton?.addEventListener('click', () => {
                if (!SESSIONS_IMPORT_ID) {
                    alert("Error: Sessions Import ID is not configured. Cannot reset status.");
                    return;
                }
                const warningMsg = `WARNING:\n\n` +
                                `This will manually clear the 'pending'/'processing' status for the Sessions website update (Import ID: ${SESSIONS_IMPORT_ID}) stored by the handler script.\n\n` +
                                `Only use this if the update process is DEFINITELY finished or cancelled, but the dashboard is still stuck showing 'Processing...'.\n\n` +
                                `Clearing the status while an import is actively running could cause delayed or incorrect status reporting until the next import completes.\n\n` +
                                `Are you sure you want to reset the status?`;

                if (confirm(warningMsg)) {
                    addActivity(`Attempting manual reset for Sessions import status (ID: ${SESSIONS_IMPORT_ID})...`);
                    optionsMenu.classList.add('hidden'); // Close menu

                    google.script.run
                        .withSuccessHandler(handleClearImportStatusResult)
                        .withFailureHandler(handleClearImportStatusResult) // Use same handler, check result.success
                        .clearSpecificImportCache(SESSIONS_IMPORT_ID); // Pass the specific ID
                }
            });


            // Theme Switch
            themeCheckbox.addEventListener('change', function() {
                const theme = this.checked ? 'light' : 'dark';
                htmlElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                feather.replace();
            });

            // Copy Log Button
            copyLogButton.addEventListener('click', () => {
                const logItems = detailedLogList.querySelectorAll('li .log-message');
                const logText = Array.from(logItems).map(item => item.textContent.trim()).reverse().join('\n');
                if (logText) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(logText).then(showCopySuccessFeedback).catch(err => {
                            console.warn("Clipboard API failed, falling back:", err);
                            tryExecCommandCopy(logText);
                        });
                    } else {
                        console.warn("Clipboard API not supported, using fallback.");
                        tryExecCommandCopy(logText);
                     }
                } else { alert("No detailed log content to copy."); }
            });

            // Options Menu Toggle
            optionsMenuButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent doc listener from closing it immediately
                optionsMenu.classList.toggle('hidden');
                if (!optionsMenu.classList.contains('hidden')) feather.replace(); // Redraw icons when shown
            });

            // --- Set Initial Theme ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-theme', savedTheme);
                if (savedTheme === 'light') themeCheckbox.checked = true;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                 // Optional: respect browser preference if no saved theme
                 htmlElement.setAttribute('data-theme', 'light');
                 themeCheckbox.checked = true;
            } else {
                themeCheckbox.checked = false; // Default dark
            }

            // --- Fetch Initial Data ---
            addLog("<li><i data-feather='loader' class='icon status-icon-checking'></i><span class='log-message'>Loading dashboard status...</span></li>");
            feather.replace();

            google.script.run
                .withSuccessHandler(updateDashboardInitial)
                .withFailureHandler((err) => {
                    console.error("Failed to load initial data:", err);
                    addLog(`<li><i data-feather='alert-triangle' class='icon status-icon-error'></i><span class='log-message'>Error loading initial dashboard status: ${err.message || err}</span></li>`);
                    updateStepUI('sync', 'error', { statusText: 'Load Error' });
                    updateStepUI('import', 'error', { statusText: 'Load Error' });
                })
                .getDashboardData();

            // --- ADDED: Environment Switch Listener ---
            envSwitchCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                const targetEnvironment = isChecked ? 'live' : 'staging';
                const currentEnvironment = currentActiveEnvironment; // Get state *before* change attempt

                // Confirmation Dialog
                const confirmationMessage = `WARNING:\n\nYou are attempting to switch the target environment to ${targetEnvironment.toUpperCase()}.\n\nAll WordPress actions (Update Website, Clear Cache) will target this environment.\n\nProceed?`;

                // Disable switch immediately to prevent rapid clicks
                this.disabled = true;

                if (confirm(confirmationMessage)) {
                    // User confirmed - call server function
                    addActivity(`Attempting to switch environment to ${targetEnvironment.toUpperCase()}...`);
                    optionsMenu.classList.add('hidden'); // Close menu

                    google.script.run
                        .withSuccessHandler(handleEnvironmentChangeSuccess)
                        .withFailureHandler(handleEnvironmentChangeFailure)
                        .setActiveEnvironment_Server(targetEnvironment);
                } else {
                    // User cancelled - revert the checkbox state visually
                    addActivity(`Environment switch to ${targetEnvironment.toUpperCase()} cancelled by user.`);
                    this.checked = !isChecked; // Set back to original state
                     // Manually update labels based on reverted state
                    envLabelStaging.classList.toggle('active', !this.checked);
                    envLabelLive.classList.toggle('active', this.checked);
                    this.disabled = false; // Re-enable immediately on cancel
                }
            });

        }); // End window load listener

        // --- Listener to close menu when clicking outside ---
        document.addEventListener('click', (event) => {
            if (optionsMenu && optionsMenuButton && !optionsMenu.classList.contains('hidden') &&
                !optionsMenuButton.contains(event.target) && !optionsMenu.contains(event.target)) {
                optionsMenu.classList.add('hidden');
            }
        });

    </script>
    <!-- ============================================= -->
    <!--                JAVASCRIPT END                 -->
    <!-- ============================================= -->

</body>
</html>