<!DOCTYPE html>
<html lang="en" data-theme="dark"> <!-- Default theme is dark -->
<head>
    <meta charset="UTF-8">
    <!-- Viewport meta tag is added by Apps Script doGet -->
    <title>Sessions Sync Dashboard</title> <!-- Title set by Apps Script doGet -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Base CSS included to prevent flash of unstyled content -->
    <style>
        /* --- Configuration: Default Dark Mode --- */
        :root {
            --bg-primary-dark: #1a1d24; --bg-secondary-dark: #252932; --bg-tertiary-dark: #313641;
            --text-primary-dark: #e0e6f0; --text-secondary-dark: #a0a8b4; --text-tertiary-dark: #767f8d;
            --accent-primary-dark: #00f5d4; --accent-secondary-dark: #00bfa5; --color-success-dark: #34d399;
            --color-warning-dark: #f59e0b; --color-error-dark: #f43f5e; --border-color-dark: #3e4450;
            --border-highlight-dark: var(--accent-primary-dark); --placeholder-color-dark: #5a6372;
            --shadow-color-dark: rgba(0, 245, 212, 0.1); --button-primary-text-dark: var(--bg-primary-dark);
            --step-border-dark: var(--border-color-dark);
            --step-bg-dark: var(--bg-secondary-dark);
            --step-disabled-opacity-dark: 0.5;
            --step-connector-color-dark: var(--border-color-dark);
            --step-indicator-bg-dark: var(--bg-tertiary-dark);
            --step-indicator-text-dark: var(--text-secondary-dark);
            --step-indicator-complete-bg-dark: var(--color-success-dark);
            --step-indicator-error-bg-dark: var(--color-error-dark);
            --step-indicator-active-bg-dark: var(--color-warning-dark);
            --step-indicator-complete-text-dark: var(--bg-primary-dark);
        }
        /* --- Configuration: Light Mode --- */
        :root[data-theme="light"] {
            --bg-primary-light: #f8f9fa; --bg-secondary-light: #ffffff; --bg-tertiary-light: #e9ecef;
            --text-primary-light: #212529; --text-secondary-light: #495057; --text-tertiary-light: #6c757d;
            --accent-primary-light: #00a991; --accent-secondary-light: #007d6a; --color-success-light: #198754;
            --color-warning-light: #ffc107; --color-error-light: #dc3545; --border-color-light: #dee2e6;
            --border-highlight-light: var(--accent-primary-light); --placeholder-color-light: #adb5bd;
            --shadow-color-light: rgba(0, 169, 145, 0.2); --button-primary-text-light: #ffffff;
            --step-border-light: var(--border-color-light);
            --step-bg-light: var(--bg-secondary-light);
            --step-disabled-opacity-light: 0.6;
            --step-connector-color-light: var(--border-color-light);
            --step-indicator-bg-light: var(--bg-tertiary-light);
            --step-indicator-text-light: var(--text-secondary-light);
            --step-indicator-complete-bg-light: var(--color-success-light);
            --step-indicator-error-bg-light: var(--color-error-light);
            --step-indicator-active-bg-light: var(--color-warning-light);
            --step-indicator-complete-text-light: #ffffff;
        }
        /* --- Theme Variable Mapping --- */
        :root {
            --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --bg-tertiary: var(--bg-tertiary-dark);
            --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --text-tertiary: var(--text-tertiary-dark);
            --accent-primary: var(--accent-primary-dark); --accent-secondary: var(--accent-secondary-dark); --color-success: var(--color-success-dark);
            --color-warning: var(--color-warning-dark); --color-error: var(--color-error-dark); --border-color: var(--border-color-dark);
            --border-highlight: var(--border-highlight-dark); --placeholder-color: var(--placeholder-color-dark);
            --shadow-color: var(--shadow-color-dark); --button-primary-text: var(--button-primary-text-dark);
            --step-border: var(--step-border-dark); --step-bg: var(--step-bg-dark); --step-disabled-opacity: var(--step-disabled-opacity-dark);
            --step-connector-color: var(--step-connector-color-dark); --step-indicator-bg: var(--step-indicator-bg-dark);
            --step-indicator-text: var(--step-indicator-text-dark); --step-indicator-complete-bg: var(--step-indicator-complete-bg-dark);
            --step-indicator-error-bg: var(--step-indicator-error-bg-dark); --step-indicator-active-bg: var(--step-indicator-active-bg-dark);
            --step-indicator-complete-text: var(--step-indicator-complete-text-dark);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 8px; --transition-speed: 0.3s; --fast-transition-speed: 0.15s;
        }
        :root[data-theme="light"] {
            --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --bg-tertiary: var(--bg-tertiary-light);
            --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --text-tertiary: var(--text-tertiary-light);
            --accent-primary: var(--accent-primary-light); --accent-secondary: var(--accent-secondary-light); --color-success: var(--color-success-light);
            --color-warning: var(--color-warning-light); --color-error: var(--color-error-light); --border-color: var(--border-color-light);
            --border-highlight: var(--border-highlight-light); --placeholder-color: var(--placeholder-color-light);
            --shadow-color: var(--shadow-color-light); --button-primary-text: var(--button-primary-text-light);
             --step-border: var(--step-border-light); --step-bg: var(--step-bg-light); --step-disabled-opacity: var(--step-disabled-opacity-light);
            --step-connector-color: var(--step-connector-color-light); --step-indicator-bg: var(--step-indicator-bg-light);
            --step-indicator-text: var(--step-indicator-text-light); --step-indicator-complete-bg: var(--step-indicator-complete-bg-light);
            --step-indicator-error-bg: var(--step-indicator-error-bg-light); --step-indicator-active-bg: var(--step-indicator-active-bg-light);
            --step-indicator-complete-text: var(--step-indicator-complete-text-light);
        }
        /* --- Base & Reset --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; color-scheme: dark light; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }

        /* --- Layout --- */
        .dashboard-container {
            position: relative; /* Needed for absolute positioning of theme switch */
            width: 100%;
            max-width: 1200px; /* Maintain max width */
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        header { text-align: center; margin-bottom: 1rem; } /* Reduced bottom margin */
        header h1 { font-size: 2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
        header p { color: var(--text-secondary); font-size: 1rem; }

        /* --- Top Right Theme Switch --- */
        .top-right-theme-switch {
            position: absolute; top: 1rem; right: 1rem; z-index: 15;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .theme-switch { display: inline-block; height: 22px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--bg-tertiary); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: var(--transition-speed); border-radius: 22px; border: 1px solid var(--border-color); }
        .slider:before { background-color: var(--text-secondary); bottom: 2px; content: ""; height: 16px; left: 3px; position: absolute; transition: var(--transition-speed); width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-secondary); }
        input:checked + .slider:before { transform: translateX(22px); background-color: var(--bg-secondary); }
        .top-right-theme-switch .icon { stroke: var(--text-tertiary); width: 18px; height: 18px; }

        /* --- Stepper UI --- */
        .stepper-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Gap between steps and connectors */
            width: 100%;
            align-items: stretch; /* Make steps equal height */
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2rem;
        }
        .step {
            background-color: var(--step-bg);
            border: 1px solid var(--step-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex: 1 1 300px; /* Allow shrinking/growing, base width 300px */
            min-width: 280px; /* Prevent steps getting too narrow */
            transition: opacity var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .step-indicator {
            width: 32px; height: 32px; border-radius: 50%;
            background-color: var(--step-indicator-bg);
            color: var(--step-indicator-text);
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.9rem;
            flex-shrink: 0;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .step-indicator .icon { width: 18px; height: 18px; } /* For icons inside indicator */
        .step-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .step-content { display: flex; flex-direction: column; gap: 0.75rem; flex-grow: 1; }
        .step-status { font-size: 0.9rem; color: var(--text-secondary); min-height: 1.6em; /* Prevent layout shifts */}
        .step-details { font-size: 0.85rem; color: var(--text-tertiary); margin-top: auto; padding-top: 0.5rem; } /* Push to bottom */
        .step-button-group { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; }

        /* Step Buttons */
        .step-button {
            border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600;
            border-radius: var(--border-radius); cursor: pointer; display: inline-flex;
            align-items: center; justify-content: center; gap: 0.5rem;
            transition: all var(--fast-transition-speed) ease; white-space: nowrap;
        }
        .step-button .icon { width: 16px; height: 16px; }
        .step-button.primary { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); color: var(--button-primary-text); box-shadow: 0 2px 8px var(--shadow-color); }
        .step-button.primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px var(--shadow-color); filter: brightness(1.1); }
        .step-button.primary:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg-tertiary); color: var(--text-tertiary); box-shadow: none; }
        .step-button.secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .step-button.secondary:hover:not(:disabled) { background-color: var(--border-color); }
        .step-button.secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .step-button.danger { background-color: transparent; color: var(--color-error); border: 1px solid var(--color-error); }
        .step-button.danger:hover:not(:disabled) { background-color: rgba(var(--color-error-dark-rgb, 244, 63, 94), 0.1); } /* Adjust RGB */
        :root[data-theme="light"] .step-button.danger:hover:not(:disabled) { background-color: rgba(var(--color-error-light-rgb, 220, 53, 69), 0.1); } /* Adjust RGB */

        /* Stepper State Styling */
        .step.step-not-recommended { opacity: var(--step-disabled-opacity); }
        .step.step-not-recommended .step-button.primary { /* Make greyed-out primary look secondary */
             background: var(--bg-tertiary); color: var(--text-tertiary); box-shadow: none;
             border: 1px solid var(--border-color);
        }
         /* Highlight for recommended step */
        .step.step-recommended { border-color: var(--border-highlight); box-shadow: 0 0 10px var(--shadow-color); }

        /* Active state */
        .step.step-active .step-indicator { background-color: var(--step-indicator-active-bg); animation: pulse-indicator 1.5s infinite ease-in-out; }
        @keyframes pulse-indicator { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .step.step-active { border-color: var(--color-warning); }

        /* Complete state */
        .step.step-complete .step-indicator { background-color: var(--step-indicator-complete-bg); color: var(--step-indicator-complete-text); }
        .step.step-complete { border-color: var(--color-success); }

         /* Error state */
        .step.step-error .step-indicator { background-color: var(--step-indicator-error-bg); color: var(--step-indicator-complete-text); }
        .step.step-error { border-color: var(--color-error); }
        .step.step-error .step-status { color: var(--color-error); font-weight: 500; }


        /* Connector (Optional visual element) */
        .step-connector { display: none; /* Hide connectors for now, can be added back */ }

        /* --- Helper Classes --- */
        .hidden { display: none !important; }


        /* --- Icon Button Styling --- */
        .icon-button {
            background: none; border: none; padding: 0.3rem; margin: 0; cursor: pointer;
            color: var(--text-tertiary); display: inline-flex; align-items: center;
            justify-content: center; border-radius: 50%; transform: scale(1);
            transition: all var(--fast-transition-speed) ease;
        }
        .icon-button:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .icon-button .icon { stroke: currentColor; width: 18px; height: 18px; transition: stroke var(--fast-transition-speed) ease; }

        /* --- Copy Button Feedback --- */
        .copy-log-button.copied { transform: scale(1.1); }
        .copy-log-button.copied .icon { stroke: var(--color-success); }
        :root[data-theme="light"] .copy-log-button.copied .icon { stroke: var(--color-success-light); }

        /* --- Lower Section (Logs) --- */
        .lower-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .log-column { background-color: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; min-height: 350px; /* Min height */ height: auto; border: 1px solid var(--border-color); }
        .log-column h2 {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; gap: 0.5rem;
        }
        .log-column h2 span { display: flex; align-items: center; gap: 0.5rem; } /* Wraps text + icon */
        .log-column h2 .icon { width: 18px; height: 18px; stroke: var(--text-secondary); }
        .copy-log-button { margin-left: auto; }
        .item-list { list-style: none; flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; max-height: 400px; /* Max height scroll */}
        .item-list::-webkit-scrollbar { width: 6px; }
        .item-list::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .item-list::-webkit-scrollbar-thumb { background-color: var(--text-tertiary); border-radius: 3px; }
        .item-list::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        .item-list li { padding: 0.6rem 0.25rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.9rem; color: var(--text-primary); }
        .item-list li:last-child { border-bottom: none; }
        .item-list .icon { width: 16px; height: 16px; flex-shrink: 0; margin-top: 0.15em; stroke-width: 2.5; }
        .item-list .log-message { flex-grow: 1; word-break: break-word; }
        .item-list .log-message.success-summary { color: var(--accent-primary); font-weight: 500;}

        /* Status/Log specific icon colors */
        .status-icon-checking, .status-icon-loader, .status-icon-clock, .status-icon-zap { color: var(--color-warning); }
        .status-icon-new, .status-icon-play-circle { color: var(--color-success); }
        .status-icon-updated, .status-icon-warning, .status-icon-alert-circle, .status-icon-refresh-cw { color: var(--color-warning); }
        .status-icon-error, .status-icon-failed, .status-icon-alert-triangle, .status-icon-x-octagon, .status-icon-trash-2, .status-icon-x-circle { color: var(--color-error); }
        .status-icon-complete, .status-icon-check-circle, .status-icon-check { color: var(--accent-primary); }
        .status-icon-info, .status-icon-chevrons-right, .status-icon-coffee, .status-icon-skipped, .status-icon-skip-forward, .status-icon-wind, .status-icon-upload-cloud { color: var(--text-tertiary); }
        .status-icon-settings, .status-icon-more-vertical, .status-icon-copy, .status-icon-list, .status-icon-align-left { color: var(--text-tertiary); }


        /* --- 3-Dot Options Menu Styling --- */
        .options-menu-container { position: relative; display: inline-block; margin-left: 0.5rem; }
        .options-menu {
            position: absolute; top: calc(100% + 5px); right: 0; background-color: var(--bg-secondary);
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0,0,0,0.08);
            z-index: 10; min-width: 220px; padding: 0.5rem 0; list-style: none; margin: 0;
            opacity: 1; visibility: visible; transform: translateY(0);
            transition: opacity var(--fast-transition-speed) ease, visibility var(--fast-transition-speed) ease, transform var(--fast-transition-speed) ease;
        }
        .options-menu.hidden { opacity: 0; visibility: hidden; transform: translateY(-5px); pointer-events: none; }
        .options-menu ul { list-style: none; padding: 0; margin: 0; }
        .options-menu li a, .options-menu li button { /* Apply to buttons too */
            display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem;
            color: var(--text-primary); text-decoration: none; font-size: 0.9rem;
            white-space: nowrap; transition: background-color var(--fast-transition-speed) ease;
            background: none; border: none; width: 100%; text-align: left; cursor: pointer;
        }
        .options-menu li a:hover, .options-menu li button:hover { background-color: var(--bg-tertiary); color: var(--accent-primary); }
        .options-menu .menu-icon { width: 16px; height: 16px; stroke-width: 2; color: var(--text-secondary); }
        .options-menu li a:hover .menu-icon, .options-menu li button:hover .menu-icon { color: var(--accent-primary); }
        .options-menu li.placeholder { padding: 0.6rem 1rem; color: var(--text-tertiary); font-style: italic; font-size: 0.9rem;}


        /* --- Responsiveness --- */
        @media (max-width: 992px) {
            .lower-section { grid-template-columns: 1fr; }
            .log-column { min-height: 300px; }
            .stepper-container { flex-direction: column; }
            .step { flex-basis: auto; } /* Let steps stack */
            .step-connector { display: none; } /* Hide connectors when stacked */
         }
        @media (max-width: 768px) {
            body { padding: 1rem 0.5rem; }
            .top-right-theme-switch { top: 0.5rem; right: 0.5rem; }
            header h1 { font-size: 1.75rem; }
            .stepper-container { gap: 0.75rem; }
            .step { padding: 1rem; }
         }
        @media (max-width: 576px) {
            html { font-size: 15px; }
            header h1 { font-size: 1.5rem; }
            .lower-section { gap: 1rem; grid-template-columns: 1fr; }
            .log-column { padding: 1rem; min-height: 250px; }
            .log-column h2 { font-size: 1.1rem; padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
            .item-list li { padding: 0.6rem 0.1rem; font-size: 0.85rem; gap: 0.5rem; }
            .step-button { padding: 0.5rem 1rem; font-size: 0.85rem; }
            .step-title { font-size: 1rem; }
            .options-menu { min-width: 180px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Theme Switcher -->
        <div class="theme-switch-wrapper top-right-theme-switch">
            <i data-feather="sun" class="icon"></i>
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider"></div>
            </label>
            <i data-feather="moon" class="icon"></i>
        </div>

        <header>
            <h1>Sessions Sync Dashboard</h1>
            <p>Sync Airtable data, update website, and manage cache.</p>
             <!-- 3-Dot Options Menu Moved Here -->
             <div class="options-menu-container" style="position: absolute; top: 3.5rem; right: 1rem;">
                <button class="icon-button options-menu-button" id="optionsMenuButton" aria-label="More options">
                    <i data-feather="settings" class="icon status-icon-settings"></i>
                </button>
                <div id="optionsMenu" class="options-menu hidden">
                    <ul>
                       <!-- Add relevant links here -->
                       <li><a href="YOUR_AIRTABLE_BASE_LINK" target="_blank" rel="noopener noreferrer"><i data-feather="airplay" class="icon menu-icon"></i> Open Airtable Base</a></li>
                       <li><a href="YOUR_GOOGLE_SHEET_LINK" target="_blank" rel="noopener noreferrer"><i data-feather="grid" class="icon menu-icon"></i> Open Google Sheet</a></li>
                       <!-- Cache Clear Moved Here -->
                       <li><button id="clearCacheMenuButton"><i data-feather="wind" class="icon menu-icon"></i> Clear Website Cache</button></li>
                       <!-- <li class="placeholder">No options configured.</li> -->
                    </ul>
                </div>
            </div>
        </header>

        <!-- Stepper UI Container -->
        <section class="stepper-container">

            <!-- Step 1: Sync Sheet -->
            <div class="step step-recommended" id="step-sync">
                <div class="step-header">
                  <span class="step-indicator" id="indicator-sync">1</span>
                  <span class="step-title">Sync Sessions</span>
                </div>
                <div class="step-content">
                  <p class="step-status" id="status-sync">Ready to sync from Airtable.</p>
                  <div class="step-details" id="details-sync"></div> <!-- Sync results: X created, Y updated -->
                  <div class="step-button-group">
                      <button class="step-button primary" id="button-sync">
                          <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Sync Sessions Now</span>
                      </button>
                      <button class="step-button secondary hidden" id="button-resync">
                          <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Sync Again</span>
                      </button>
                       <button class="step-button secondary hidden" id="button-retry-sync">
                           <i data-feather="refresh-cw" class="icon"></i><span class="button-text">Retry Sync</span>
                       </button>
                  </div>
                </div>
            </div>

            <!-- Connector (Optional) -->
            <!-- <div class="step-connector" id="connector-1-2"></div> -->

            <!-- Step 2: Update Website -->
            <div class="step step-not-recommended" id="step-import">
                <div class="step-header">
                  <span class="step-indicator" id="indicator-import">2</span>
                  <span class="step-title">Update Website</span>
                </div>
                <div class="step-content">
                  <p class="step-status" id="status-import">Run 'Sync Sessions' first.</p>
                  <div class="step-details" id="details-import"></div> <!-- WP results: X created, Y updated... -->
                   <div class="step-button-group">
                      <button class="step-button primary" id="button-import">
                          <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Update Website Now</span>
                      </button>
                      <button class="step-button secondary hidden" id="button-reimport">
                          <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Update Again</span>
                       </button>
                       <button class="step-button secondary hidden" id="button-retry-import">
                           <i data-feather="upload-cloud" class="icon"></i><span class="button-text">Retry Update</span>
                       </button>
                      <button class="step-button danger hidden" id="button-cancel-import">
                          <i data-feather="x-circle" class="icon"></i><span class="button-text">Cancel Update</span>
                      </button>
                   </div>
                </div>
            </div>

            <!-- Connector (Optional) -->
            <!-- <div class="step-connector" id="connector-2-3"></div> -->

             <!-- Step 3: Clear Cache (Removed as separate step, moved to options menu) -->
            <!--
            <div class="step step-not-recommended" id="step-cache">
                <div class="step-header">
                  <span class="step-indicator" id="indicator-cache">3</span>
                  <span class="step-title">Clear Website Cache</span>
                </div>
                <div class="step-content">
                  <p class="step-status" id="status-cache">Run 'Update Website' first.</p>
                  <div class="step-details" id="details-cache"></div>
                   <div class="step-button-group">
                      <button class="step-button secondary" id="button-cache">
                          <i data-feather="wind" class="icon"></i><span class="button-text">Clear Cache Now</span>
                      </button>
                       <button class="step-button secondary hidden" id="button-retry-cache">
                           <i data-feather="wind" class="icon"></i><span class="button-text">Retry Clear</span>
                       </button>
                   </div>
                </div>
            </div>
             -->

        </section>
        <!-- End Stepper UI -->


        <!-- Log Section -->
        <section class="lower-section">
            <div class="log-column recent-activity">
                 <h2><span><i data-feather="list" class="icon status-icon-list"></i>Recent Activity</span></h2>
                <ul class="item-list" id="recent-activity-list">
                     <li><i data-feather='info' class='icon status-icon-info'></i><span class="log-message">Dashboard ready.</span></li>
                </ul>
            </div>
            <div class="log-column detailed-log">
                 <h2>
                    <span><i data-feather="align-left" class="icon status-icon-align-left"></i>Detailed Log</span>
                    <button id="copyLogButton" class="icon-button copy-log-button" aria-label="Copy detailed log">
                        <i data-feather="copy" class="icon status-icon-copy"></i>
                    </button>
                 </h2>
                <ul class="item-list" id="detailed-log-list">
                      <li><i data-feather='coffee' class='icon status-icon-coffee'></i><span class="log-message">Waiting for actions...</span></li>
                </ul>
            </div>
        </section>
        <!-- End Log Section -->
    </div>

    <script>
        // --- Global Config Passed from GAS ---
        // Use <! ... > notation for GAS scriptlets to avoid potential conflicts
        const SESSIONS_IMPORT_ID = <?= sessionsImportId ?> || null; // Get import ID passed from doGet

        // --- DOM Elements ---
        let themeCheckbox, htmlElement, copyLogButton, optionsMenuButton, optionsMenu, clearCacheMenuButton;
        let stepSync, indicatorSync, statusSync, detailsSync, buttonSync, buttonResync, buttonRetrySync;
        let stepImport, indicatorImport, statusImport, detailsImport, buttonImport, buttonReimport, buttonRetryImport, buttonCancelImport;
        // let stepCache, indicatorCache, statusCache, detailsCache, buttonCache, buttonRetryCache; // Removed Step 3 elements
        let recentActivityList, detailedLogList;

        // --- State ---
        let currentWpRunId = null; // Track the runId of the *current* initiated import
        let pollingIntervalId = null;
        const POLLING_INTERVAL_MS = 5000; // Check WP status every 5 seconds

        // --- Helper Functions ---

        // ** NEW: Core UI Update Function for Steps **
        function updateStepUI(stepId, state, options = {}) {
            const stepElement = document.getElementById(`step-${stepId}`);
            const indicatorElement = document.getElementById(`indicator-${stepId}`);
            const statusElement = document.getElementById(`status-${stepId}`);
            const detailsElement = document.getElementById(`details-${stepId}`);
            // Primary action buttons
            const buttonPrimary = document.getElementById(`button-${stepId}`);
            const buttonPrimaryText = buttonPrimary?.querySelector('.button-text');
            const buttonPrimaryIcon = buttonPrimary?.querySelector('.icon');
            // Secondary/alternate action buttons
            const buttonResync = document.getElementById('button-resync'); // Specific to sync
            const buttonRetrySync = document.getElementById('button-retry-sync'); // Specific to sync
            const buttonReimport = document.getElementById('button-reimport'); // Specific to import
            const buttonRetryImport = document.getElementById('button-retry-import'); // Specific to import
            const buttonCancelImport = document.getElementById('button-cancel-import'); // Specific to import
            // const buttonRetryCache = document.getElementById('button-retry-cache'); // Specific to cache (Removed)

            if (!stepElement || !indicatorElement || !statusElement || !detailsElement) {
                console.error(`UI elements not found for step: ${stepId}`);
                return;
            }

            // 1. Reset state classes & hide optional buttons
            stepElement.classList.remove('step-ready', 'step-recommended', 'step-not-recommended', 'step-active', 'step-complete', 'step-error');
            indicatorElement.innerHTML = stepId === 'sync' ? '1' : (stepId === 'import' ? '2' : '3'); // Reset indicator number/icon
            if (buttonPrimary) buttonPrimary.disabled = false;
            if (buttonPrimaryText) buttonPrimaryText.textContent = `Run ${capitalizeFirstLetter(stepId)} Now`; // Simplified default text needed adjustment
            if (buttonPrimaryIcon) buttonPrimaryIcon.setAttribute('data-feather', stepId === 'sync' ? 'refresh-cw' : (stepId === 'import' ? 'upload-cloud' : 'wind'));
             // Hide all secondary buttons by default
            [buttonResync, buttonRetrySync, buttonReimport, buttonRetryImport, buttonCancelImport].forEach(btn => btn?.classList.add('hidden'));


             // Apply default button text based on stepId (needs adjustment)
             if (buttonPrimaryText) {
                 if (stepId === 'sync') buttonPrimaryText.textContent = 'Sync Sessions Now';
                 else if (stepId === 'import') buttonPrimaryText.textContent = 'Update Website Now';
                 // else if (stepId === 'cache') buttonPrimaryText.textContent = 'Clear Cache Now';
             }


            // 2. Apply new state class
            stepElement.classList.add(`step-${state}`);

            // 3. Update Status Text
            if (options.statusText !== undefined) statusElement.textContent = options.statusText;

            // 4. Update Details HTML
            if (options.detailsHtml !== undefined) detailsElement.innerHTML = options.detailsHtml;
            else detailsElement.innerHTML = ''; // Clear details if not provided

            // 5. Handle State-Specific UI Changes
            switch (state) {
                case 'ready':
                    // Default state - button enabled
                     if (buttonPrimary) buttonPrimary.disabled = false;
                    break;
                case 'recommended':
                     if (buttonPrimary) buttonPrimary.disabled = false;
                    // Highlight applied by class
                    break;
                case 'not-recommended':
                     if (buttonPrimary) buttonPrimary.disabled = false; // Still clickable
                    // Grey-out applied by class
                    break;
                case 'active':
                    if (buttonPrimary) buttonPrimary.disabled = true;
                    if (buttonPrimaryText) buttonPrimaryText.textContent = options.activeButtonText || 'Processing...';
                    indicatorElement.innerHTML = `<i data-feather="loader" class="icon"></i>`; // Spinner
                    // Show cancel button only for import step during active state
                    if (stepId === 'import' && buttonCancelImport) buttonCancelImport.classList.remove('hidden');
                    break;
                case 'complete':
                    if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide main button
                    indicatorElement.innerHTML = `<i data-feather="check" class="icon"></i>`; // Checkmark
                    // Show appropriate "Re-run" button
                    if (stepId === 'sync' && buttonResync) buttonResync.classList.remove('hidden');
                    if (stepId === 'import' && buttonReimport) buttonReimport.classList.remove('hidden');
                    break;
                case 'error':
                    if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide main button
                    indicatorElement.innerHTML = `<i data-feather="x" class="icon"></i>`; // Cross
                     // Show appropriate "Retry" button
                    if (stepId === 'sync' && buttonRetrySync) buttonRetrySync.classList.remove('hidden');
                    if (stepId === 'import' && buttonRetryImport) buttonRetryImport.classList.remove('hidden');
                    // if (stepId === 'cache' && buttonRetryCache) buttonRetryCache.classList.remove('hidden');
                    break;
                case 'cancelled': // Specific state for import
                     if (buttonPrimary) buttonPrimary.classList.add('hidden'); // Hide main button
                     indicatorElement.innerHTML = `<i data-feather="x-circle" class="icon"></i>`; // Cancel icon
                     if (buttonReimport) buttonReimport.classList.remove('hidden'); // Allow re-run
                     break;
                 default:
                     if (buttonPrimary) buttonPrimary.disabled = false; // Ensure enabled by default
            }

            feather.replace(); // Update icons
        }


        function addLog(htmlContent) {
            if (!detailedLogList || !htmlContent) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent; // Assumes htmlContent is like "<li>...</li>"
            if (tempDiv.firstChild) {
                 // Insert at top, but limit total items for performance
                 if (detailedLogList.children.length >= 200) {
                    detailedLogList.removeChild(detailedLogList.lastChild);
                 }
                detailedLogList.prepend(tempDiv.firstChild);
            }
        }

        function addActivity(text) { // Simplified to take plain text
             if (!recentActivityList || !text) return;
             let icon = 'info'; let iconClass = 'status-icon-info';
             const lowerText = String(text).toLowerCase();

             // Determine icon based on keywords (adjust as needed)
             if (lowerText.includes('sync complete') || lowerText.includes('update complete') || lowerText.includes('cache cleared')) { icon = 'check-circle'; iconClass = 'status-icon-complete'; }
             else if (lowerText.includes('started sync') || lowerText.includes('started update') || lowerText.includes('triggered') || lowerText.includes('started cache clear')) { icon = 'loader'; iconClass = 'status-icon-checking'; }
             else if (lowerText.includes('failed')) { icon = 'alert-triangle'; iconClass = 'status-icon-error'; }
             else if (lowerText.includes('cancelled')) { icon = 'x-circle'; iconClass = 'status-icon-warning'; }
             else if (lowerText.includes('waiting') || lowerText.includes('processing')) { icon = 'clock'; iconClass = 'status-icon-checking'; }

             const li = document.createElement('li');
             li.innerHTML = `<i data-feather='${icon}' class='icon ${iconClass}'></i><span class="log-message">${text}</span>`;

             // Insert at top, limit total items
             if (recentActivityList.children.length >= 50) {
                 recentActivityList.removeChild(recentActivityList.lastChild);
             }
             recentActivityList.prepend(li);
             feather.replace({ width: 16, height: 16 }); // Redraw icons in list
        }

        function formatDisplayTimestamp(isoTimestamp) {
            if (!isoTimestamp) return 'Never';
            try {
                return new Date(isoTimestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
            } catch (e) { return 'Invalid Date'; }
        }

        function clearLogs() {
            if (recentActivityList) recentActivityList.innerHTML = '';
            if (detailedLogList) detailedLogList.innerHTML = '';
        }

        function formatDuration(ms) {
             if (ms === undefined || ms === null || ms < 0) return '--';
             if (ms < 1000) return `${ms}ms`;
             return `${(ms / 1000).toFixed(1)}s`;
        }

         function formatCounters(counters) {
            if (!counters) return '';
            let parts = [];
            if (counters.created > 0) parts.push(`${counters.created} created`);
            if (counters.updated > 0) parts.push(`${counters.updated} updated`);
            if (counters.deleted > 0) parts.push(`${counters.deleted} removed`);
            if (counters.skipped > 0) parts.push(`${counters.skipped} skipped`);
            if (parts.length === 0 && (counters.created === 0 && counters.updated === 0 && counters.deleted === 0 && counters.skipped >= 0)) {
                return 'No changes.'; // Explicitly state no changes if all are 0 or just skipped > 0
            }
            return parts.join(', ') || 'No changes detected.';
        }

         function showCopySuccessFeedback() {
            if (!copyLogButton) return;
            copyLogButton.classList.add('copied');
            setTimeout(() => { if (copyLogButton) copyLogButton.classList.remove('copied'); }, 1500);
        }

        function tryExecCommandCopy(textToCopy) {
            const textArea = document.createElement("textarea");
            // ... (styling as before) ...
            textArea.value = textToCopy; document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            let success = false;
            try {
                success = document.execCommand('copy');
                if (success) { showCopySuccessFeedback(); } else { alert("Fallback copy failed."); }
            } catch (err) { alert("Error copying log: " + err); }
            finally { document.body.removeChild(textArea); }
            return success;
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }


        // --- Polling Function ---
        function startPollingWpStatus(importId) {
            if (pollingIntervalId) clearInterval(pollingIntervalId); // Clear previous interval if any

            addActivity(`Website Update (ID ${importId}) initiated. Checking status...`);

            pollingIntervalId = setInterval(() => {
                console.log("Polling WP status for import ID:", importId);
                google.script.run
                    .withSuccessHandler(handleWpImportStatusUpdate)
                    .withFailureHandler(handlePollingFailure)
                    .getImportStatus(importId);
            }, POLLING_INTERVAL_MS);
        }

        function stopPollingWpStatus() {
             if (pollingIntervalId) {
                 clearInterval(pollingIntervalId);
                 pollingIntervalId = null;
                 console.log("Polling stopped.");
             }
        }


// --- Server Call Handlers ---

        // ** UPDATED: Handles the result AFTER the user clicks a Sync button **
        function handleSheetSyncResult(result) {
            console.log("Sheet Sync Result:", result);

            // 1. Stop any visual "active" state for Sync step
            // (updateStepUI will handle setting the new state below)

            // 2. Add Logs from this specific run
            // Clear logs *before* adding new ones if desired, or just prepend
            // clearLogs(); // Optional: Clear logs before showing results of this run
            result.lastSyncResults?.logs?.forEach(logItem => addLog(logItem));
            result.lastSyncResults?.recentItems?.forEach(activityItem => addActivity(activityItem)); // Add server-side recent items

            // 3. Update Step 1 (Sync) UI based on the result of THIS run
            if (result.success) {
                 const counters = result.lastSyncResults?.typeCounters?.sessions || {};
                 const duration = result.lastSyncDuration;
                 updateStepUI('sync', 'complete', {
                     statusText: `Sync Complete (${formatDuration(duration)}).`,
                     detailsHtml: formatCounters(counters)
                 });
                 addActivity("Session Sync Finished Successfully."); // Add clear activity summary

                 // 4. Update Step 2 (Import) UI - Make it Recommended
                 updateStepUI('import', 'recommended', {
                     statusText: 'Ready to update website.'
                     // Keep existing details (last run info) or clear them? Keeping is probably fine.
                     // detailsHtml: '' // Optionally clear previous import results here
                 });

            } else {
                // Sync Failed
                const errorMsg = result.error || "Unknown sync error.";
                 updateStepUI('sync', 'error', {
                     statusText: `Sync Failed: ${errorMsg}`
                     // Optionally clear details on error
                     // detailsHtml: ''
                 });
                 addActivity(`Session Sync Failed: ${errorMsg}`);

                 // 4. Update Step 2 (Import) UI - Keep it Not Recommended
                 updateStepUI('import', 'not-recommended', {
                     statusText: "Run 'Sync Sessions' successfully first."
                     // Keep existing details of last import run visible
                 });
            }

             // 5. Update Cache Clear button state based on *last known* WP status
             // Check the current state of the import step to decide if cache clear should be enabled
             const importStepElement = document.getElementById('step-import');
             if (clearCacheMenuButton) {
                 clearCacheMenuButton.disabled = !(importStepElement?.classList.contains('step-complete'));
             }
        }

        
        function handleWpImportInitiation(result) {
             console.log("WP Import Initiation Result:", result);
             result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon'></i><span class="log-message">${logLine}</span></li>`)); // Add initiation logs

            if (result.success && result.runId && result.status.startsWith('initiated')) {
                currentWpRunId = result.runId; // Store the run ID for this attempt
                 updateStepUI('import', 'active', {
                     statusText: 'Waiting for WordPress update to start...',
                     activeButtonText: 'Initiated...' // Keep button disabled
                 });
                 addActivity(`Website Update (ID ${SESSIONS_IMPORT_ID}) triggered.`);
                 // Start polling for status
                 startPollingWpStatus(SESSIONS_IMPORT_ID);
            } else {
                 // Initiation failed (WP error, HTTP error, timeout)
                 updateStepUI('import', 'error', {
                     statusText: `Update Failed to Start: ${result.message || 'Unknown initiation error.'}`
                 });
                 addActivity(`Website Update Failed to Start: ${result.message}`);
                 currentWpRunId = null; // Reset run ID
            }
        }

        function handleWpImportStatusUpdate(statusResult) {
            console.log("WP Import Status Update:", statusResult);
            if (!statusResult) {
                // Could happen if cache expires or getImportStatus returns null unexpectedly
                console.warn("Received null status update during polling.");
                 updateStepUI('import', 'active', { // Keep it visually active but show uncertainty
                     statusText: 'Checking status... (No response from cache)'
                 });
                 addActivity("Checking website update status... (Waiting for response)");
                return;
            }

             // Check if the status is for the run we initiated (if applicable)
             // if (currentWpRunId && statusResult.runId && statusResult.runId !== currentWpRunId) {
             //    console.log(`Ignoring status update for run ${statusResult.runId}, current run is ${currentWpRunId}`);
             //    return; // Ignore status from a different run
             // }

            switch (statusResult.status) {
                case 'pending':
                     updateStepUI('import', 'active', {
                         statusText: statusResult.message || 'Website update is pending or running...',
                         activeButtonText: 'Processing...'
                     });
                     addActivity(statusResult.message || "Website update in progress...");
                    // Continue polling
                    break;
                case 'complete':
                    stopPollingWpStatus();
                    handleWpImportCompletion(statusResult);
                    break;
                case 'error': // Error reported by getImportStatus itself (e.g., cache read error)
                    stopPollingWpStatus();
                    handleWpImportFailure(statusResult);
                    break;
                case 'cancelled': // If we explicitly store cancelled status
                    stopPollingWpStatus();
                    handleWpImportCancellation(statusResult); // Use a specific handler
                    break;
                 case 'unknown': // e.g. cache miss after pending
                     updateStepUI('import', 'active', { // Stay active, but indicate issue
                         statusText: 'Checking status... (Cache status lost)',
                         activeButtonText: 'Processing...'
                     });
                     addActivity("Checking website update status... (Status lost)");
                     break;
                default: // Any other status or unexpected value
                    console.warn("Unknown WP import status received:", statusResult.status);
                    updateStepUI('import', 'active', {
                         statusText: `Processing... (Status: ${statusResult.status})`,
                         activeButtonText: 'Processing...'
                     });
                    // Continue polling cautiously
            }
        }

        function handleWpImportCompletion(statusResult) {
             console.log("WP Import Complete:", statusResult);
             const details = statusResult ? formatCounters(statusResult) : 'Details unavailable.';
             const duration = (statusResult && statusResult.startTime && statusResult.endTime) ? formatDuration((statusResult.endTime - statusResult.startTime) * 1000) : '';
             updateStepUI('import', 'complete', {
                 statusText: `Website Update Complete ${duration ? `(${duration})` : ''}.`,
                 detailsHtml: details
             });
             addActivity("Website Update Finished.");
             currentWpRunId = null; // Clear run ID

             // Make Cache Step Recommended (If we had Step 3)
             // updateStepUI('cache', 'recommended', { statusText: 'Ready to clear cache.' });

             // Make Sync Step Recommended again
             updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
        }

         function handleWpImportFailure(statusResult) {
             console.error("WP Import Failed:", statusResult);
             const errorMsg = statusResult?.message || 'Unknown error during update.';
             updateStepUI('import', 'error', {
                 statusText: `Website Update Failed: ${errorMsg}`
             });
             addActivity(`Website Update Failed: ${errorMsg}`);
             stopPollingWpStatus();
             currentWpRunId = null;
             // Make Sync Step Recommended again
             updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
         }

        function handlePollingFailure(error) {
             console.error("Polling Failure:", error);
             // Don't stop polling immediately, maybe transient error
             updateStepUI('import', 'active', {
                 statusText: 'Error checking status... Retrying.',
                 activeButtonText: 'Processing...'
             });
             addActivity("Error checking website update status.");
         }

        function handleWpImportCancellation(statusResult) {
            console.log("WP Import Cancelled:", statusResult);
            const cancelMsg = statusResult?.message || 'Update cancelled.';
            updateStepUI('import', 'cancelled', { // Use a specific state if styled
                 statusText: `Website Update Cancelled. ${cancelMsg}`
            });
            addActivity(`Website Update Cancelled.`);
            stopPollingWpStatus();
            currentWpRunId = null;
             // Make Sync Step Recommended again
             updateStepUI('sync', 'recommended', { statusText: 'Ready to sync.'});
        }

        function handleCancelResult(result) {
             console.log("Cancel Result:", result);
             result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon'></i><span class="log-message">${logLine}</span></li>`));

             if (result.success) {
                 // Use the specific handler for cancelled state
                 handleWpImportCancellation({ status: 'cancelled', message: result.message });
             } else {
                  // Show error message, but keep polling maybe? Or force stop? Force stop is safer.
                  const errorMsg = result.message || "Failed to send cancel request.";
                  updateStepUI('import', 'active', { // Keep active visually but show error briefly?
                       statusText: `Cancel request failed: ${errorMsg}. Checking status...`,
                       activeButtonText: 'Processing...'
                  });
                  addActivity(`Cancel request failed: ${errorMsg}`);
                  // Do NOT stop polling here if cancel failed - it might still be running.
             }
        }

        function handleCacheClearResult(result) {
             console.log("Cache Clear Result:", result);
             result.log?.split('\n').forEach(logLine => addLog(`<li><i data-feather='chevrons-right' class='icon'></i><span class="log-message">${logLine}</span></li>`));

             // Re-enable the button in the options menu
             if(clearCacheMenuButton) clearCacheMenuButton.disabled = false;

             if (result.success) {
                 addActivity("Website Cache Cleared Successfully.");
                 // Optional: Update a status area if cache had its own step/card
             } else {
                  addActivity(`Cache Clear Failed: ${result.message}`);
                  alert(`Cache Clear Failed: ${result.message}`); // Show alert for this action
             }
        }


        function updateDashboardInitial(data) {
            console.log("Initial Data Received:", data);
            clearLogs();
            addLog("<li><i data-feather='info' class='icon status-icon-info'></i><span class='log-message'>Dashboard loaded. Checking initial states...</span></li>");

            const lastSyncStatus = data.lastSyncStatus;
            const lastSyncTime = data.lastSyncTimestamp;
            const lastSyncDuration = data.lastSyncDuration;
            const syncCounters = data.lastSyncResults?.typeCounters?.sessions || {};
            const wpStatus = data.wpImportStatus; // Object like { status: 'pending'/'complete'/'error', ... }

            let wpIsPendingOrActive = wpStatus && wpStatus.status === 'pending';

            // --- Set Initial Step States ---

            // Handle Active WP Import FIRST
            if (wpIsPendingOrActive) {
                console.log("Initial state: WP Import is pending. Starting polling.");
                // Update Step 2 (Import) UI
                updateStepUI('import', 'active', {
                    statusText: wpStatus.message || 'Website update pending...',
                    activeButtonText: 'Processing...' // Disable primary button
                });
                currentWpRunId = wpStatus.runId || null;
                startPollingWpStatus(SESSIONS_IMPORT_ID);

                // Update Step 1 (Sync) based on *historical* data, but not recommended
                const syncHistoryIcon = lastSyncStatus === 'Success' ? 'check' : (lastSyncStatus === 'Failed' ? 'x' : 'minus');
                const syncHistoryDetails = `Last: ${formatDisplayTimestamp(lastSyncTime)} <i data-feather="${syncHistoryIcon}" class="icon" style="width:12px; height:12px;"></i>`;
                updateStepUI('sync', lastSyncStatus === 'Success' ? 'complete' : (lastSyncStatus === 'Failed' ? 'error' : 'ready'), {
                    statusText: `Website update in progress...`, // Indicate why sync isn't recommended now
                    detailsHtml: syncHistoryDetails
                    // Ensure main sync button is hidden, show Re-run/Retry
                });

            } else {
                // WP Import is NOT active - Default to recommending Sync
                console.log("Initial state: WP Import not active. Recommending Sync.");

                // Step 1: Sync - Always recommend, but show last run details
                const syncHistoryIcon = lastSyncStatus === 'Success' ? 'check' : (lastSyncStatus === 'Failed' ? 'x' : 'minus');
                const syncHistoryDetails = `Last: ${formatDisplayTimestamp(lastSyncTime)} <i data-feather="${syncHistoryIcon}" class="icon" style="width:12px; height:12px;"></i> ${formatCounters(syncCounters)} (${formatDuration(lastSyncDuration)})`;
                updateStepUI('sync', 'recommended', {
                    statusText: 'Ready to sync sessions.',
                    detailsHtml: lastSyncStatus !== 'Never Run' ? syncHistoryDetails : 'No previous sync data.'
                });

                // Step 2: Import - Not recommended initially
                let importStatusText = "Run 'Sync Sessions' first.";
                let importDetailsHtml = '';
                let importInitialState = 'not-recommended';

                // Display details of the LAST completed/failed import if available
                if (wpStatus && (wpStatus.status === 'complete' || wpStatus.status === 'error' || wpStatus.status === 'cancelled')) {
                     const importHistoryIcon = wpStatus.status === 'complete' ? 'check' : 'x';
                     const importTimestamp = wpStatus.endTime ? new Date(wpStatus.endTime * 1000).toISOString() : null; // Use endTime for completion time
                     importDetailsHtml = `Last: ${formatDisplayTimestamp(importTimestamp)} <i data-feather="${importHistoryIcon}" class="icon" style="width:12px; height:12px;"></i> ${formatCounters(wpStatus)}`;
                     // Even though we show history, keep it not-recommended until a fresh sync
                } else if (wpStatus && wpStatus.status === 'not_configured') {
                    importInitialState = 'error'; // Show as error if not configured
                    importStatusText = 'Website Update not configured.';
                    importDetailsHtml = '';
                    if(buttonImport) buttonImport.disabled = true;
                }

                updateStepUI('import', importInitialState, {
                    statusText: importStatusText,
                    detailsHtml: importDetailsHtml
                });
            }

            // Set initial state of Cache Clear menu item (enabled if last WP import was complete)
            if (clearCacheMenuButton) {
                 clearCacheMenuButton.disabled = !(wpStatus && wpStatus.status === 'complete');
            }


            // Populate Logs from last stored run (sheet sync only initially)
            data.lastSyncResults?.logs?.forEach(logItem => addLog(logItem));
            data.lastSyncResults?.recentItems?.forEach(activityItem => addActivity(activityItem));

            addLog("<li><i data-feather='check-circle' class='icon status-icon-complete'></i><span class='log-message'>Initial status check complete.</span></li>");
            feather.replace(); // Render all icons
        }


        // --- Initial Load and Event Listener Assignment ---
        window.addEventListener('load', () => {
             console.log("Dashboard loaded.");

             // Assign DOM Elements
             themeCheckbox = document.getElementById('theme-checkbox');
             htmlElement = document.documentElement;
             copyLogButton = document.getElementById('copyLogButton');
             optionsMenuButton = document.getElementById('optionsMenuButton');
             optionsMenu = document.getElementById('optionsMenu');
             clearCacheMenuButton = document.getElementById('clearCacheMenuButton'); // Button in menu

             // Step 1 Elements
             stepSync = document.getElementById('step-sync');
             indicatorSync = document.getElementById('indicator-sync');
             statusSync = document.getElementById('status-sync');
             detailsSync = document.getElementById('details-sync');
             buttonSync = document.getElementById('button-sync');
             buttonResync = document.getElementById('button-resync');
             buttonRetrySync = document.getElementById('button-retry-sync');

             // Step 2 Elements
             stepImport = document.getElementById('step-import');
             indicatorImport = document.getElementById('indicator-import');
             statusImport = document.getElementById('status-import');
             detailsImport = document.getElementById('details-import');
             buttonImport = document.getElementById('button-import');
             buttonReimport = document.getElementById('button-reimport');
             buttonRetryImport = document.getElementById('button-retry-import');
             buttonCancelImport = document.getElementById('button-cancel-import');

             // Step 3 Elements (Removed)

             // Log Elements
             recentActivityList = document.getElementById('recent-activity-list');
             detailedLogList = document.getElementById('detailed-log-list');

            // Basic check
            if (!buttonSync || !buttonImport || !themeCheckbox || !copyLogButton || !optionsMenuButton || !optionsMenu || !clearCacheMenuButton) {
                 console.error("CRITICAL ERROR: Failed to find essential UI elements on load.");
                 alert("Dashboard UI failed to load correctly. Please refresh or contact support.");
                 return;
             }

            // --- Attach Event Listeners ---

            // Step 1: Sync
            [buttonSync, buttonResync, buttonRetrySync].forEach(btn => {
                btn?.addEventListener('click', () => {
                    updateStepUI('sync', 'active', { statusText: 'Syncing sessions...', activeButtonText: 'Syncing...' });
                    addActivity("Started Session Sync.");
                    google.script.run
                        .withSuccessHandler(handleSheetSyncResult)
                        .withFailureHandler(handleSheetSyncResult) // Use same handler, check result.success
                        .runSheetSync_Dashboard();
                });
            });

             // Step 2: Import
            [buttonImport, buttonReimport, buttonRetryImport].forEach(btn => {
                 btn?.addEventListener('click', () => {
                     if (!SESSIONS_IMPORT_ID) {
                         alert("Error: Website Update Import ID is not configured.");
                         return;
                     }
                     updateStepUI('import', 'active', { statusText: 'Starting website update...', activeButtonText: 'Initiating...' });
                     addActivity("Started Website Update.");
                     stopPollingWpStatus(); // Ensure no old polling is running
                     google.script.run
                         .withSuccessHandler(handleWpImportInitiation)
                         .withFailureHandler(handleWpImportInitiation) // Check result.success
                         .initiateWordPressImport(SESSIONS_IMPORT_ID);
                 });
            });

            // Step 2: Cancel Import
            buttonCancelImport?.addEventListener('click', () => {
                 if (!SESSIONS_IMPORT_ID) return;
                 if (!confirm("Are you sure you want to cancel the current website update?")) return;

                 // Visually disable cancel button immediately
                 buttonCancelImport.disabled = true;
                 buttonCancelImport.querySelector('.button-text').textContent = 'Cancelling...';
                 addActivity("Sending cancel request for website update...");

                 google.script.run
                     .withSuccessHandler(handleCancelResult)
                     .withFailureHandler(handleCancelResult) // Check result.success
                     .cancelWordPressImport(SESSIONS_IMPORT_ID);
            });


            // Options Menu: Clear Cache
            clearCacheMenuButton?.addEventListener('click', () => {
                 if(clearCacheMenuButton.disabled) return; // Prevent double click
                 clearCacheMenuButton.disabled = true; // Disable button in menu
                 addActivity("Started Website Cache Clear.");
                 optionsMenu.classList.add('hidden'); // Close menu

                 google.script.run
                    .withSuccessHandler(handleCacheClearResult)
                    .withFailureHandler(handleCacheClearResult) // Check result.success
                    .clearBreezeCache();
            });


            // Theme Switch
            themeCheckbox.addEventListener('change', function() {
                const theme = this.checked ? 'light' : 'dark';
                htmlElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                feather.replace();
            });

            // Copy Log Button
            copyLogButton.addEventListener('click', () => {
                const logItems = detailedLogList.querySelectorAll('li .log-message');
                const logText = Array.from(logItems).map(item => item.textContent.trim()).reverse().join('\n');
                if (logText) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(logText).then(showCopySuccessFeedback).catch(err => tryExecCommandCopy(logText));
                    } else { tryExecCommandCopy(logText); }
                } else { alert("No detailed log content to copy."); }
            });

            // Options Menu Toggle
            optionsMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                optionsMenu.classList.toggle('hidden');
                if (!optionsMenu.classList.contains('hidden')) feather.replace();
            });

             // --- Set Initial Theme ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                htmlElement.setAttribute('data-theme', savedTheme);
                if (savedTheme === 'light') themeCheckbox.checked = true;
            } else {
                themeCheckbox.checked = false; // Default dark
            }

             // --- Fetch Initial Data ---
             addLog("<li><i data-feather='loader' class='icon status-icon-checking'></i><span class='log-message'>Loading dashboard status...</span></li>");
             feather.replace();

             google.script.run
                 .withSuccessHandler(updateDashboardInitial)
                 .withFailureHandler((err) => {
                      console.error("Failed to load initial data:", err);
                      addLog(`<li><i data-feather='alert-triangle' class='icon status-icon-error'></i><span class='log-message'>Error loading initial dashboard status: ${err.message || err}</span></li>`);
                      updateStepUI('sync', 'error', { statusText: 'Load Error' });
                      updateStepUI('import', 'error', { statusText: 'Load Error' });
                      // updateStepUI('cache', 'error', { statusText: 'Load Error' });
                 })
                 .getDashboardData(); // Fetches sheet sync AND wp status

        }); // End window load listener

        // --- Listener to close menu when clicking outside ---
        document.addEventListener('click', (event) => {
            if (optionsMenu && optionsMenuButton && !optionsMenu.classList.contains('hidden') &&
                !optionsMenuButton.contains(event.target) && !optionsMenu.contains(event.target)) {
                optionsMenu.classList.add('hidden');
            }
        });

    </script>

</body>
</html>